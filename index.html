<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PenÄ›Å¾enka â€“ OsobnÃ­ finance</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f0e0c;
    --bg2: #1a1916;
    --bg3: #242220;
    --card: #1e1d1b;
    --card2: #252422;
    --border: #2e2c29;
    --border2: #3a3835;
    --text: #f0ece4;
    --text2: #a09890;
    --text3: #6b6560;
    --gold: #c9a84c;
    --gold2: #e8c97a;
    --gold-dim: rgba(201,168,76,0.12);
    --green: #4caf78;
    --green-dim: rgba(76,175,120,0.12);
    --red: #e05c5c;
    --red-dim: rgba(224,92,92,0.12);
    --blue: #5b9bd5;
    --blue-dim: rgba(91,155,213,0.12);
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  /* Light theme */
  [data-theme="light"] {
    --bg: #e8e4dc;
    --bg2: #f5f2ed;
    --bg3: #d5d1c9;
    --card: #faf9f7;
    --card2: #efebe6;
    --border: #b8b4ac;
    --border2: #a39f97;
    --text: #0a0908;
    --text2: #1f1e1c;
    --text3: #4a4740;
    --gold: #8a6d1f;
    --gold2: #9f7d2a;
    --gold-dim: rgba(138,109,31,0.15);
    --green: #16602f;
    --green-dim: rgba(22,96,47,0.15);
    --red: #a02020;
    --red-dim: rgba(160,32,32,0.15);
    --blue: #1e4d75;
    --blue-dim: rgba(30,77,117,0.15);
    --shadow: 0 8px 32px rgba(10,9,8,0.15);
  }

  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }

  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
  .sidebar {
    width: 220px;
    min-height: 100vh;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 28px 16px;
    position: fixed;
    left: 0; top: 0; bottom: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--gold2);
    letter-spacing: -0.5px;
    margin-bottom: 6px;
    padding: 0 8px;
  }
  .logo span { color: var(--text3); font-weight: 300; font-size: 11px; display: block; font-family: 'IBM Plex Sans', sans-serif; letter-spacing: 0.05em; text-transform: uppercase; }

  .nav-section {
    margin-top: 32px;
    flex: 1;
  }
  .nav-label {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
    padding: 0 8px;
    margin-bottom: 6px;
    margin-top: 20px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--text2);
    font-size: 14px;
    font-weight: 400;
    transition: all 0.18s;
    margin-bottom: 2px;
    border: 1px solid transparent;
  }
  .nav-item:hover { background: var(--bg3); color: var(--text); }
  .nav-item.active {
    background: var(--gold-dim);
    color: var(--gold2);
    border-color: rgba(201,168,76,0.2);
  }
  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  .sidebar-bottom {
    padding: 12px 8px;
    border-top: 1px solid var(--border);
    margin-top: auto;
    font-size: 12px;
    color: var(--text3);
    text-align: center;
  }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  .main {
    margin-left: 220px;
    flex: 1;
    padding: 36px 40px;
    min-height: 100vh;
  }

  .page { display: none; }
  .page.active { display: block; animation: fadeIn 0.25s ease; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* â”€â”€â”€ PAGE HEADER â”€â”€â”€ */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
  }
  .page-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 32px;
    font-weight: 500;
    color: var(--text);
    line-height: 1.1;
  }
  .page-subtitle { color: var(--text2); font-size: 14px; margin-top: 4px; }

  /* â”€â”€â”€ CARDS â”€â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
  }
  .card-title {
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 12px;
  }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

  /* â”€â”€â”€ STAT CARDS â”€â”€â”€ */
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.gold::before { background: linear-gradient(90deg, var(--gold), transparent); }
  .stat-card.green::before { background: linear-gradient(90deg, var(--green), transparent); }
  .stat-card.red::before { background: linear-gradient(90deg, var(--red), transparent); }
  .stat-card.blue::before { background: linear-gradient(90deg, var(--blue), transparent); }

  .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); margin-bottom: 8px; }
  .stat-value { font-family: 'IBM Plex Mono', monospace; font-size: 28px; font-weight: 500; line-height: 1; }
  .stat-value.gold { color: var(--gold2); }
  .stat-value.green { color: var(--green); }
  .stat-value.red { color: var(--red); }
  .stat-value.blue { color: var(--blue); }
  .stat-sub { font-size: 12px; color: var(--text3); margin-top: 6px; }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.18s;
  }
  .btn-primary {
    background: var(--gold);
    color: #1a1400;
  }
  .btn-primary:hover { background: var(--gold2); transform: translateY(-1px); }
  .btn-outline {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--text2);
  }
  .btn-outline:hover { border-color: var(--gold); color: var(--gold2); }
  .btn-ghost {
    background: transparent;
    color: var(--text3);
    padding: 6px 10px;
  }
  .btn-ghost:hover { color: var(--text); background: var(--bg3); }
  .btn-danger {
    background: var(--red-dim);
    color: var(--red);
    border: 1px solid rgba(224,92,92,0.2);
  }
  .btn-danger:hover { background: rgba(224,92,92,0.2); }

  .btn-sm { padding: 6px 12px; font-size: 13px; border-radius: 8px; }

  /* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€ */
  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 12px; color: var(--text2); margin-bottom: 6px; display: block; letter-spacing: 0.03em; }
  .form-input, .form-select {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    transition: border-color 0.18s;
    appearance: none;
  }
  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--gold);
  }
  .form-select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236b6560' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }

  .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .input-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

  /* â”€â”€â”€ MODAL â”€â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: var(--radius);
    padding: 28px;
    width: 480px;
    max-width: 94vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.96) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  .modal-title { font-family: 'IBM Plex Mono', monospace; font-size: 20px; font-weight: 500; }
  .modal-close { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 20px; line-height: 1; transition: color 0.15s; }
  .modal-close:hover { color: var(--text); }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }

  /* â”€â”€â”€ TRANSACTION LIST â”€â”€â”€ */
  .tx-list { display: flex; flex-direction: column; gap: 1px; }
  .tx-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--card);
    border-radius: var(--radius-sm);
    margin-bottom: 4px;
    border: 1px solid var(--border);
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .tx-item:hover { border-color: var(--border2); background: var(--card2); }
  
  /* Swipe actions */
  .swipe-container {
    position: relative;
    overflow: hidden;
    touch-action: pan-y;
  }
  .swipe-content {
    position: relative;
    z-index: 2;
    background: var(--card);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .swipe-actions {
    position: absolute;
    top: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    z-index: 1;
  }
  .swipe-actions-left {
    left: 0;
    padding-left: 16px;
  }
  .swipe-actions-right {
    right: 0;
    padding-right: 16px;
  }
  .swipe-action {
    width: 70px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .swipe-action.edit {
    background: var(--blue);
    color: white;
  }
  .swipe-action.delete {
    background: var(--red);
    color: white;
  }
  .swipe-action:hover {
    opacity: 0.9;
    transform: scale(1.05);
  }
  .tx-icon {
    width: 38px; height: 38px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    flex-shrink: 0;
  }
  .tx-info { flex: 1; min-width: 0; }
  .tx-name { font-size: 14px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tx-meta { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .tx-amount { font-family: 'IBM Plex Mono', monospace; font-size: 16px; font-weight: 500; text-align: right; }
  .tx-amount.income { color: var(--green); }
  .tx-amount.expense { color: var(--red); }
  .tx-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
  .tx-item:hover .tx-actions { opacity: 1; }

  /* â”€â”€â”€ PROGRESS BAR â”€â”€â”€ */
  .progress-bar-wrap { margin-top: 8px; }
  .progress-bar-bg {
    height: 6px;
    background: var(--bg3);
    border-radius: 99px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    border-radius: 99px;
    transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  }
  .progress-bar-fill.green { background: var(--green); }
  .progress-bar-fill.gold { background: var(--gold); }
  .progress-bar-fill.red { background: var(--red); }
  .progress-bar-fill.blue { background: var(--blue); }

  /* â”€â”€â”€ BUDGET ITEM â”€â”€â”€ */
  .budget-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 18px;
    margin-bottom: 8px;
    transition: all 0.15s;
  }
  .budget-item:hover { border-color: var(--border2); }
  .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .budget-name { font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
  .budget-amounts { font-size: 13px; color: var(--text3); }
  .budget-amounts strong { color: var(--text); }

  /* â”€â”€â”€ GOAL CARD â”€â”€â”€ */
  .goal-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.15s;
  }
  .goal-card:hover { border-color: var(--border2); transform: translateY(-2px); }
  .goal-emoji { font-size: 28px; margin-bottom: 10px; }
  .goal-name { font-family: 'IBM Plex Mono', monospace; font-size: 17px; font-weight: 500; margin-bottom: 4px; }
  .goal-deadline { font-size: 12px; color: var(--text3); margin-bottom: 14px; }
  .goal-amounts { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; }
  .goal-amount-current { color: var(--gold2); font-weight: 500; }
  .goal-amount-target { color: var(--text3); }
  .goal-monthly { margin-top: 12px; font-size: 12px; color: var(--text2); background: var(--bg3); padding: 8px 12px; border-radius: 8px; }
  .goal-monthly strong { color: var(--green); }

  /* â”€â”€â”€ INVESTMENT CARD â”€â”€â”€ */
  .invest-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 6px;
    transition: all 0.15s;
  }
  .invest-item:hover { border-color: var(--border2); }
  .invest-ticker {
    width: 44px; height: 44px;
    background: var(--bg3);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--gold2);
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  .invest-info { flex: 1; }
  .invest-name { font-size: 14px; font-weight: 500; }
  .invest-detail { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .invest-value { text-align: right; }
  .invest-current { font-family: 'IBM Plex Mono', monospace; font-size: 16px; font-weight: 500; }
  .invest-gain { font-size: 12px; margin-top: 2px; }
  .invest-gain.pos { color: var(--green); }
  .invest-gain.neg { color: var(--red); }

  /* â”€â”€â”€ CHIP / TAG â”€â”€â”€ */
  .chip {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.03em;
  }
  .chip.income { background: var(--green-dim); color: var(--green); }
  .chip.expense { background: var(--red-dim); color: var(--red); }
  .chip.transfer { background: var(--blue-dim); color: var(--blue); }

  /* â”€â”€â”€ CHART CONTAINER â”€â”€â”€ */
  .chart-wrap { position: relative; }

  /* â”€â”€â”€ TOGGLE GROUP â”€â”€â”€ */
  .toggle-group {
    display: flex;
    background: var(--bg3);
    border-radius: var(--radius-sm);
    padding: 3px;
    gap: 2px;
  }
  .toggle-btn {
    flex: 1;
    padding: 7px 14px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: var(--text3);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.18s;
  }
  .toggle-btn.active {
    background: var(--card);
    color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }

  /* â”€â”€â”€ SLIDER â”€â”€â”€ */
  .slider-wrap { margin-bottom: 20px; }
  .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .slider-label { font-size: 13px; color: var(--text2); }
  .slider-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 16px;
    color: var(--gold2);
    background: var(--gold-dim);
    padding: 2px 10px;
    border-radius: 6px;
  }
  input[type=range] {
    width: 100%;
    appearance: none;
    height: 5px;
    border-radius: 99px;
    background: var(--bg3);
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    appearance: none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--gold);
    border: 3px solid var(--bg);
    box-shadow: 0 0 0 1px var(--gold);
    cursor: pointer;
    transition: transform 0.15s;
  }
  input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.15); }

  /* â”€â”€â”€ PROJECTION PANEL â”€â”€â”€ */
  .projection-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .proj-stat {
    background: var(--bg3);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    text-align: center;
  }
  .proj-stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }
  .proj-stat-value { font-family: 'IBM Plex Mono', monospace; font-size: 20px; color: var(--gold2); }

  /* â”€â”€â”€ ACCOUNT CARD â”€â”€â”€ */
  .account-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.15s;
  }
  .account-card:hover { border-color: var(--border2); }
  .account-icon { font-size: 24px; margin-bottom: 10px; }
  .account-name { font-size: 13px; color: var(--text2); margin-bottom: 4px; }
  .account-balance { font-family: 'IBM Plex Mono', monospace; font-size: 24px; font-weight: 500; color: var(--text); }
  .account-currency { font-size: 13px; color: var(--text3); }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text3);
  }
  .empty-state-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
  .empty-state-text { font-size: 14px; line-height: 1.6; }

  /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
  .divider { height: 1px; background: var(--border); margin: 20px 0; }

  /* â”€â”€â”€ SECTION HEADER â”€â”€â”€ */
  .section-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
  }
  .section-title { 
    font-size: 17px; 
    font-weight: 600; 
    color: var(--text); 
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 99px; }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: var(--radius-sm);
    padding: 12px 18px;
    font-size: 14px;
    color: var(--text);
    box-shadow: var(--shadow);
    z-index: 9999;
    display: none;
    animation: slideUp 0.25s ease;
  }
  .toast.show { display: block; }
  .toast.success { border-left: 3px solid var(--green); }
  .toast.error { border-left: 3px solid var(--red); }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
  @media (max-width: 900px) {
    .grid-4 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 640px) {
    .sidebar { display: none; }
    .main { margin-left: 0; padding: 20px 16px; }
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo">PenÄ›Å¾enka<span>osobnÃ­ finance</span></div>
  <div class="nav-section">
    <div class="nav-label">HlavnÃ­</div>
    <div class="nav-item active" onclick="navigate('dashboard')">
      <span class="nav-icon">â—ˆ</span> PÅ™ehled
    </div>
    <div class="nav-item" onclick="navigate('transactions')">
      <span class="nav-icon">â‡„</span> Transakce
    </div>
    <div class="nav-item" onclick="navigate('accounts')">
      <span class="nav-icon">â—»</span> ÃšÄty
    </div>
    <div class="nav-label">PlÃ¡novÃ¡nÃ­</div>
    <div class="nav-item" onclick="navigate('budgets')">
      <span class="nav-icon">â—·</span> RozpoÄty
    </div>
    <div class="nav-item" onclick="navigate('goals')">
      <span class="nav-icon">â—</span> CÃ­le
    </div>
    <div class="nav-item" onclick="navigate('investments')">
      <span class="nav-icon">â—†</span> Investice
    </div>
    <div class="nav-item" onclick="navigate('cashflow')">
      <span class="nav-icon">â‡µ</span> Cashflow
    </div>
  </div>
  <button onclick="toggleTheme()" style="
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 12px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text2);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  " onmouseover="this.style.background='var(--card)';this.style.borderColor='var(--border2)';" onmouseout="this.style.background='var(--bg3)';this.style.borderColor='var(--border)';">
    <span id="theme-icon">ğŸŒ™</span>
    <span id="theme-text">SvÄ›tlÃ½ reÅ¾im</span>
  </button>
  <div class="sidebar-bottom">LokÃ¡lnÃ­ ÃºloÅ¾iÅ¡tÄ› Â· VaÅ¡e data jsou bezpeÄnÃ¡</div>
</nav>

<!-- MAIN -->
<main class="main">

  <!-- â•â•â•â• DASHBOARD â•â•â•â• -->
  <div id="page-dashboard" class="page active">
    <div class="page-header">
      <div>
        <div class="page-title">DobrÃ½ den ğŸ‘‹</div>
        <div class="page-subtitle" id="dashboard-date"></div>
      </div>
      <button class="btn btn-primary" onclick="openModal('modal-transaction')">ï¼‹ NovÃ¡ transakce</button>
    </div>

    <div class="grid-4" style="margin-bottom:20px;">
      <div class="stat-card gold">
        <div class="stat-label">CelkovÃ½ zÅ¯statek</div>
        <div class="stat-value gold" id="dash-balance">0 KÄ</div>
        <div class="stat-sub">VÅ¡echny ÃºÄty</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">PÅ™Ã­jmy tento mÄ›sÃ­c</div>
        <div class="stat-value green" id="dash-income">0 KÄ</div>
        <div class="stat-sub" id="dash-income-count">0 transakcÃ­</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">VÃ½daje tento mÄ›sÃ­c</div>
        <div class="stat-value red" id="dash-expenses">0 KÄ</div>
        <div class="stat-sub" id="dash-expense-count">0 transakcÃ­</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-label">Portfolio investic</div>
        <div class="stat-value blue" id="dash-portfolio">0 KÄ</div>
        <div class="stat-sub" id="dash-portfolio-gain">+0 KÄ zisk</div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:20px;">
      <div class="card">
        <div class="card-title">Cashflow â€“ poslednÃ­ch 6 mÄ›sÃ­cÅ¯</div>
        <div class="chart-wrap" style="height:200px;">
          <canvas id="chart-cashflow"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">VÃ½daje podle kategoriÃ­</div>
        <div class="chart-wrap" style="height:200px; display:flex; align-items:center; justify-content:center;">
          <canvas id="chart-categories" style="max-width:200px; max-height:200px;"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="section-header">
          <div class="section-title">PoslednÃ­ transakce</div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('transactions')">VÅ¡e â†’</button>
        </div>
        <div id="dash-recent-tx"><div class="empty-state"><div class="empty-state-icon">â‡„</div><div class="empty-state-text">ZatÃ­m Å¾Ã¡dnÃ© transakce</div></div></div>
      </div>
      <div class="card">
        <div class="section-header">
          <div class="section-title">Stav rozpoÄtÅ¯</div>
          <button class="btn btn-ghost btn-sm" onclick="navigate('budgets')">VÅ¡e â†’</button>
        </div>
        <div id="dash-budgets-preview"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• TRANSACTIONS â•â•â•â• -->
  <div id="page-transactions" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Transakce</div>
        <div class="page-subtitle">VÅ¡echny pÅ™Ã­jmy a vÃ½daje</div>
      </div>
      <button class="btn btn-primary" onclick="openModal('modal-transaction')">ï¼‹ PÅ™idat</button>
    </div>

    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <input class="form-input" style="flex:1; min-width:180px;" placeholder="ğŸ”  Hledat transakce..." id="tx-search" oninput="renderTransactions()">
        <select class="form-select" style="width:160px;" id="tx-filter-type" onchange="renderTransactions()">
          <option value="">VÅ¡e</option>
          <option value="income">PÅ™Ã­jmy</option>
          <option value="expense">VÃ½daje</option>
        </select>
        <select class="form-select" style="width:180px;" id="tx-filter-cat" onchange="renderTransactions()">
          <option value="">VÅ¡echny kategorie</option>
        </select>
      </div>
    </div>

    <div id="tx-list-container"></div>
  </div>

  <!-- â•â•â•â• ACCOUNTS â•â•â•â• -->
  <div id="page-accounts" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">ÃšÄty</div>
        <div class="page-subtitle">SprÃ¡va vaÅ¡ich ÃºÄtÅ¯ a penÄ›Å¾enek</div>
      </div>
      <button class="btn btn-primary" onclick="openModal('modal-account')">ï¼‹ PÅ™idat ÃºÄet</button>
    </div>
    <div class="grid-3" id="accounts-grid" style="margin-bottom:24px;"></div>
  </div>

  <!-- â•â•â•â• BUDGETS â•â•â•â• -->
  <div id="page-budgets" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">RozpoÄty</div>
        <div class="page-subtitle" id="budget-month-label">AktuÃ¡lnÃ­ mÄ›sÃ­c</div>
      </div>
      <button class="btn btn-primary" onclick="openModal('modal-budget')">ï¼‹ PÅ™idat rozpoÄet</button>
    </div>
    <div id="budgets-list"></div>
  </div>

  <!-- â•â•â•â• GOALS â•â•â•â• -->
  <div id="page-goals" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">SpoÅ™icÃ­ cÃ­le</div>
        <div class="page-subtitle">PlÃ¡nujte a sledujte svÃ© finanÄnÃ­ cÃ­le</div>
      </div>
      <button class="btn btn-primary" onclick="openModal('modal-goal')">ï¼‹ NovÃ½ cÃ­l</button>
    </div>
    <div class="grid-3" id="goals-grid"></div>
  </div>

  <!-- â•â•â•â• INVESTMENTS â•â•â•â• -->
  <div id="page-investments" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Investice</div>
        <div class="page-subtitle">Portfolio a projekce budoucÃ­ hodnoty</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <div id="price-status" style="font-size:12px;color:var(--text3);display:flex;align-items:center;gap:6px;"></div>
        <button class="btn btn-outline btn-sm" onclick="openModal('modal-apikey')" title="Nastavit API klÃ­Ä">âš™ API klÃ­Ä</button>
        <button class="btn btn-primary" onclick="openModal('modal-investment')">ï¼‹ PÅ™idat aktivum</button>
      </div>
    </div>

    <div class="grid-4" style="margin-bottom:20px;">
      <div class="stat-card gold">
        <div class="stat-label">CelkovÃ¡ hodnota</div>
        <div class="stat-value gold" id="inv-total">0 KÄ</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">CelkovÃ½ zisk</div>
        <div class="stat-value green" id="inv-gain">0 KÄ</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-label">VloÅ¾eno celkem</div>
        <div class="stat-value blue" id="inv-invested">0 KÄ</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">VÃ½nos</div>
        <div class="stat-value" id="inv-pct" style="color:var(--text);">0%</div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:20px;">
      <div class="card">
        <div class="section-header">
          <div class="section-title">Aktiva v portfoliu</div>
        </div>
        <div id="inv-list"></div>
      </div>
      <div class="card">
        <div class="section-header">
          <div class="section-title">Alokace aktiv</div>
          <div style="font-size:12px;color:var(--text3);">PodÃ­vej se na podÃ­l kaÅ¾dÃ©ho aktiva a sleduj jeho dennÃ­ cenovÃ© zmÄ›ny</div>
        </div>
        <div id="portfolio-treemap" style="height:320px;border-radius:8px;padding:8px;overflow:auto;"></div>
      </div>
    </div>

    <!-- BOND / DEPOSIT CALCULATOR -->
    <div class="card" style="margin-bottom:20px;">
      <div class="section-header">
        <div class="section-title">ğŸ’° KalkulaÄka fixnÃ­ch investic s Ãºrokem</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:28px;margin-bottom:24px;">
        <div>
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">NÃ¡zev investice</label>
            <input class="form-input" type="text" id="bond-name" placeholder="napÅ™. StÃ¡tnÃ­ dluhopis 2029" value="">
          </div>
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">Typ investice</label>
            <select class="form-select" id="bond-category">
              <option value="bond">ğŸ“œ StÃ¡tnÃ­/firemnÃ­ dluhopis</option>
              <option value="deposit">ğŸ¦ TermÃ­novanÃ½ vklad</option>
              <option value="platform">ğŸ¢ InvestiÄnÃ­ platforma</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">PoÄÃ¡teÄnÃ­ investice (KÄ)</label>
            <input class="form-input" type="number" id="bond-principal" placeholder="100 000" min="0" step="1000" value="100000" oninput="calculateBond()">
          </div>
          <div class="input-row" style="margin-bottom:16px;">
            <div class="form-group">
              <label class="form-label">Datum nÃ¡kupu</label>
              <input class="form-input" type="date" id="bond-purchase-date" oninput="calculateBond()">
            </div>
            <div class="form-group">
              <label class="form-label">Doba splatnosti (roky)</label>
              <input class="form-input" type="number" id="bond-years" placeholder="5" min="1" max="30" step="1" value="5" oninput="calculateBond()">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">RoÄnÃ­ ÃºrokovÃ¡ sazba (%)</label>
            <input class="form-input" type="number" id="bond-rate" placeholder="4.5" min="0" max="20" step="0.1" value="4.5" oninput="calculateBond()">
          </div>
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">
              Typ ÃºroÄenÃ­
              <span style="font-size:12px;color:var(--text3);font-weight:400;margin-left:6px;" title="NÃ¡povÄ›da">â“˜</span>
            </label>
            <select class="form-select" id="bond-type" onchange="calculateBond()">
              <option value="simple">ProstÃ© ÃºroÄenÃ­</option>
              <option value="compound">SloÅ¾enÃ© ÃºroÄenÃ­</option>
            </select>
            <div style="margin-top:8px;padding:10px 12px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text3);line-height:1.6;">
              <div style="margin-bottom:6px;"><strong style="color:var(--text2);">ğŸ“Š ProstÃ© ÃºroÄenÃ­:</strong><br>Ãšrok se poÄÃ­tÃ¡ jen z pÅ¯vodnÃ­ ÄÃ¡stky. Typicky u krÃ¡tkÃ½ch investic.</div>
              <div><strong style="color:var(--text2);">ğŸ“ˆ SloÅ¾enÃ© ÃºroÄenÃ­:</strong><br>Ãšrok se pÅ™ipoÄÃ­tÃ¡vÃ¡ a dÃ¡le ÃºroÄÃ­ (Ãºrok z Ãºroku). Typicky u dlouhodobÃ½ch investic a dluhopisÅ¯.</div>
              <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:11px;">
                <strong style="color:var(--gold2);">Kdy co pouÅ¾Ã­t?</strong><br>
                â€¢ <strong>ProstÃ©:</strong> TermÃ­novanÃ© vklady do 1 roku, nÄ›kterÃ© krÃ¡tkÃ© dluhopisy<br>
                â€¢ <strong>SloÅ¾enÃ©:</strong> Dluhopisy, investiÄnÃ­ platformy, dlouhodobÃ© vklady
              </div>
            </div>
          </div>
          <button class="btn btn-primary" id="bond-save-btn" onclick="saveBond()" style="width:100%;">ğŸ’¾ UloÅ¾it investici</button>
        </div>
        <div style="background:linear-gradient(135deg, var(--bg3) 0%, var(--bg2) 100%);border-radius:var(--radius);padding:28px;display:flex;flex-direction:column;gap:20px;">
          <div id="bond-current-value" style="display:none;margin-bottom:8px;padding-bottom:20px;border-bottom:1px solid var(--border);"></div>
          
          <!-- Final value card -->
          <div style="background:rgba(201,168,76,0.08);border-radius:12px;padding:20px;border:1px solid rgba(201,168,76,0.2);">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <div style="width:8px;height:8px;border-radius:50%;background:var(--gold2);"></div>
              <div style="font-size:13px;color:var(--text3);font-weight:500;">Hodnota pÅ™i splatnosti</div>
            </div>
            <div style="font-family:'IBM Plex Mono',monospace;font-size:32px;font-weight:700;color:var(--gold2);letter-spacing:-0.5px;" id="bond-final">115 000 KÄ</div>
          </div>

          <!-- Profit and yield cards -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
            <div style="background:rgba(76,175,120,0.08);border-radius:12px;padding:18px;border:1px solid rgba(76,175,120,0.2);">
              <div style="font-size:12px;color:var(--text3);margin-bottom:6px;font-weight:500;">Zisk z ÃºrokÅ¯</div>
              <div style="font-family:'IBM Plex Mono',monospace;font-size:20px;font-weight:600;color:var(--green);" id="bond-profit">+15 000 KÄ</div>
            </div>
            <div style="background:var(--bg3);border-radius:12px;padding:18px;border:1px solid var(--border);">
              <div style="font-size:12px;color:var(--text3);margin-bottom:6px;font-weight:500;">EfektivnÃ­ vÃ½nos</div>
              <div style="font-family:'IBM Plex Mono',monospace;font-size:20px;font-weight:600;color:var(--text);" id="bond-yield">15.0%</div>
            </div>
          </div>

          <!-- Formula -->
          <div style="background:var(--bg);border-radius:10px;padding:16px;border:1px solid var(--border);">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="opacity:0.5;">
                <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <div style="font-size:12px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">VÃ½poÄet</div>
            </div>
            <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--text2);line-height:1.8;" id="bond-formula">FV = 100 000 Ã— (1 + 0.045)âµ</div>
          </div>
        </div>
      </div>

      <!-- Saved bonds list -->
      <div style="border-top:1px solid var(--border);padding-top:20px;">
        <div class="section-header" style="margin-bottom:16px;">
          <div class="section-title">ğŸ“‹ Moje fixnÃ­ investice</div>
        </div>
        <div id="bonds-list"></div>
      </div>
    </div>

    <!-- PROJECTION -->
    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸ“ˆ Projekce budoucÃ­ hodnoty</div>
        <div class="toggle-group" id="scenario-toggle">
          <button class="toggle-btn active" onclick="setScenario('all')">VÅ¡echny scÃ©nÃ¡Å™e</button>
          <button class="toggle-btn" onclick="setScenario('conservative')">KonzervativnÃ­</button>
          <button class="toggle-btn" onclick="setScenario('balanced')">VyvÃ¡Å¾enÃ½</button>
          <button class="toggle-btn" onclick="setScenario('growth')">RÅ¯stovÃ½</button>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 300px; gap:28px;">
        <div>
          <div class="projection-stats">
            <div class="proj-stat">
              <div class="proj-stat-label">Za 10 let</div>
              <div class="proj-stat-value" id="proj-10">â€”</div>
            </div>
            <div class="proj-stat">
              <div class="proj-stat-label">Za 20 let</div>
              <div class="proj-stat-value" id="proj-20">â€”</div>
            </div>
            <div class="proj-stat">
              <div class="proj-stat-label">Za 30 let</div>
              <div class="proj-stat-value" id="proj-30">â€”</div>
            </div>
          </div>
          <div class="chart-wrap" style="height:260px;">
            <canvas id="chart-projection"></canvas>
          </div>
        </div>

        <div>
          <div class="slider-wrap">
            <div class="slider-header">
              <span class="slider-label">MÄ›sÃ­ÄnÃ­ pÅ™Ã­spÄ›vek</span>
              <span class="slider-value" id="lbl-monthly">2 000 KÄ</span>
            </div>
            <input type="range" min="0" max="50000" step="500" value="2000" id="sl-monthly" oninput="updateProjection()">
          </div>
          <div class="slider-wrap">
            <div class="slider-header">
              <span class="slider-label">InvestiÄnÃ­ horizont</span>
              <span class="slider-value" id="lbl-horizon">20 let</span>
            </div>
            <input type="range" min="1" max="40" step="1" value="20" id="sl-horizon" oninput="updateProjection()">
          </div>
          <div class="slider-wrap">
            <div class="slider-header">
              <span class="slider-label">KonzervativnÃ­ vÃ½nos</span>
              <span class="slider-value" id="lbl-cons">4%</span>
            </div>
            <input type="range" min="1" max="10" step="0.5" value="4" id="sl-cons" oninput="updateProjection()">
          </div>
          <div class="slider-wrap">
            <div class="slider-header">
              <span class="slider-label">VyvÃ¡Å¾enÃ½ vÃ½nos</span>
              <span class="slider-value" id="lbl-bal">7%</span>
            </div>
            <input type="range" min="1" max="15" step="0.5" value="7" id="sl-bal" oninput="updateProjection()">
          </div>
          <div class="slider-wrap">
            <div class="slider-header">
              <span class="slider-label">RÅ¯stovÃ½ vÃ½nos</span>
              <span class="slider-value" id="lbl-growth">10%</span>
            </div>
            <input type="range" min="1" max="20" step="0.5" value="10" id="sl-growth" oninput="updateProjection()">
          </div>
          <div style="margin-top:16px; padding:14px; background:var(--bg3); border-radius:var(--radius-sm); font-size:12px; color:var(--text3); line-height:1.6;">
            Projekce poÄÃ­tÃ¡ se sloÅ¾enÃ½m ÃºroÄenÃ­m. VÃ½poÄet je orientaÄnÃ­ a nezohledÅˆuje inflaci ani danÄ›.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• CASHFLOW â•â•â•â• -->
  <div id="page-cashflow" class="page">
    <div class="page-header">
      <div>
        <div class="page-title">Cashflow plÃ¡novÃ¡nÃ­</div>
        <div class="page-subtitle">KompletnÃ­ pÅ™ehled pÅ™Ã­jmÅ¯, vÃ½dajÅ¯ a spoÅ™enÃ­</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('income')" style="border:1px solid var(--border2);">ï¼‹ PÅ™Ã­jem</button>
        <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('fixed')" style="border:1px solid var(--border2);">ï¼‹ FixnÃ­ vÃ½daj</button>
        <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('variable')" style="border:1px solid var(--border2);">ï¼‹ VariabilnÃ­ vÃ½daj</button>
        <button class="btn btn-primary btn-sm" onclick="openCashflowModal('saving')">ï¼‹ SpoÅ™enÃ­</button>
      </div>
    </div>

    <!-- 5 summary cards -->
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px;">
      <div class="stat-card green">
        <div class="stat-label">PÅ™Ã­jmy / mÄ›sÃ­c</div>
        <div class="stat-value green" id="cf-total-income">0 KÄ</div>
        <div class="stat-sub" id="cf-income-count">0 poloÅ¾ek</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">FixnÃ­ vÃ½daje</div>
        <div class="stat-value red" id="cf-total-fixed">0 KÄ</div>
        <div class="stat-sub" id="cf-fixed-count">0 poloÅ¾ek</div>
      </div>
      <div class="stat-card" style="--accent:var(--blue);">
        <div class="stat-label">VariabilnÃ­ limity</div>
        <div class="stat-value blue" id="cf-total-variable">0 KÄ</div>
        <div class="stat-sub" id="cf-variable-count">0 poloÅ¾ek</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-label">SpoÅ™enÃ­ / mÄ›sÃ­c</div>
        <div class="stat-value gold" id="cf-total-saving">0 KÄ</div>
        <div class="stat-sub" id="cf-saving-count">0 poloÅ¾ek</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">VolnÃ© cashflow</div>
        <div class="stat-value" id="cf-free" style="color:var(--text);">0 KÄ</div>
        <div class="stat-sub" id="cf-free-pct">0 % z pÅ™Ã­jmÅ¯</div>
      </div>
    </div>

    <!-- 4 lists in 2x2 grid -->
    <div class="grid-2" style="margin-bottom:20px;">
      <div class="card">
        <div class="section-header">
          <div class="section-title">ğŸ’° PravidelnÃ© pÅ™Ã­jmy</div>
          <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('income')">ï¼‹ pÅ™idat</button>
        </div>
        <div id="cf-income-list"></div>
      </div>
      <div class="card">
        <div class="section-header">
          <div class="section-title">ğŸ“Œ FixnÃ­ vÃ½daje</div>
          <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('fixed')">ï¼‹ pÅ™idat</button>
        </div>
        <div id="cf-fixed-list"></div>
      </div>
      <div class="card">
        <div class="section-header">
          <div class="section-title">ğŸ“Š VariabilnÃ­ vÃ½daje s limitem</div>
          <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('variable')">ï¼‹ pÅ™idat</button>
        </div>
        <div id="cf-variable-list"></div>
      </div>
      <div class="card">
        <div class="section-header">
          <div class="section-title">ğŸ¯ SpoÅ™enÃ­ a cÃ­le</div>
          <button class="btn btn-ghost btn-sm" onclick="openCashflowModal('saving')">ï¼‹ pÅ™idat</button>
        </div>
        <div id="cf-saving-list"></div>
      </div>
    </div>

    <!-- Waterfall + donut -->
    <div class="grid-2">
      <div class="card">
        <div class="section-header">
          <div class="section-title">Tok penÄ›z â€“ mÄ›sÃ­ÄnÃ­ pÅ™ehled</div>
        </div>
        <div style="height:300px;">
          <canvas id="chart-cf-waterfall"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="section-header">
          <div class="section-title">RozloÅ¾enÃ­ vÃ½dajÅ¯ a spoÅ™enÃ­</div>
        </div>
        <div style="height:300px;display:flex;align-items:center;justify-content:center;">
          <canvas id="chart-cf-donut" style="max-width:260px;max-height:260px;"></canvas>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- â•â•â•â• MODALS â•â•â•â• -->

<!-- Transaction Modal -->
<div class="modal-overlay" id="modal-transaction">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="tx-modal-title">NovÃ¡ transakce</div>
      <button class="modal-close" onclick="closeModal('modal-transaction')">Ã—</button>
    </div>
    <input type="hidden" id="tx-edit-id" value="">
    <div class="form-group">
      <label class="form-label">Typ</label>
      <div class="toggle-group" id="tx-type-toggle">
        <button class="toggle-btn active" onclick="setTxType('expense')">VÃ½daj</button>
        <button class="toggle-btn" onclick="setTxType('income')">PÅ™Ã­jem</button>
        <button class="toggle-btn" onclick="setTxType('transfer')">PÅ™evod</button>
      </div>
    </div>
    <input type="hidden" id="tx-type-val" value="expense">
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">ÄŒÃ¡stka (KÄ)</label>
        <input class="form-input" type="number" id="tx-amount" placeholder="0" min="0">
      </div>
      <div class="form-group">
        <label class="form-label">Datum</label>
        <input class="form-input" type="date" id="tx-date">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">NÃ¡zev / popis</label>
      <input class="form-input" id="tx-name" placeholder="napÅ™. NÃ¡kup potravin">
    </div>
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">Kategorie</label>
        <select class="form-select" id="tx-category"></select>
      </div>
      <div class="form-group">
        <label class="form-label">ÃšÄet</label>
        <select class="form-select" id="tx-account"></select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">PoznÃ¡mka (nepovinnÃ©)</label>
      <input class="form-input" id="tx-note" placeholder="VolitelnÃ¡ poznÃ¡mka...">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-transaction')">ZruÅ¡it</button>
      <button class="btn btn-primary" id="tx-save-btn" onclick="saveTransaction()">UloÅ¾it transakci</button>
    </div>
  </div>
</div>

<!-- Account Modal -->
<div class="modal-overlay" id="modal-account">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="acc-modal-title">NovÃ½ ÃºÄet</div>
      <button class="modal-close" onclick="closeModal('modal-account')">Ã—</button>
    </div>
    <input type="hidden" id="acc-edit-id" value="">
    <div class="form-group">
      <label class="form-label">NÃ¡zev ÃºÄtu</label>
      <input class="form-input" id="acc-name" placeholder="napÅ™. BÄ›Å¾nÃ½ ÃºÄet">
    </div>
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">Typ</label>
        <select class="form-select" id="acc-type">
          <option value="bank">ğŸ¦ BankovnÃ­ ÃºÄet</option>
          <option value="savings">ğŸ’° SpoÅ™icÃ­ ÃºÄet</option>
          <option value="cash">ğŸ’µ Hotovost</option>
          <option value="credit">ğŸ’³ KreditnÃ­ karta</option>
          <option value="invest">ğŸ“ˆ InvestiÄnÃ­ ÃºÄet</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">PoÄÃ¡teÄnÃ­ zÅ¯statek (KÄ)</label>
        <input class="form-input" type="number" id="acc-balance" placeholder="0">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-account')">ZruÅ¡it</button>
      <button class="btn btn-primary" id="acc-save-btn" onclick="saveAccount()">PÅ™idat ÃºÄet</button>
    </div>
  </div>
</div>

<!-- Budget Modal -->
<div class="modal-overlay" id="modal-budget">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="bud-modal-title">NovÃ½ rozpoÄet</div>
      <button class="modal-close" onclick="closeModal('modal-budget')">Ã—</button>
    </div>
    <input type="hidden" id="bud-edit-id" value="">
    <div class="form-group">
      <label class="form-label">Kategorie</label>
      <select class="form-select" id="bud-category"></select>
    </div>
    <div class="form-group">
      <label class="form-label">MÄ›sÃ­ÄnÃ­ limit (KÄ)</label>
      <input class="form-input" type="number" id="bud-limit" placeholder="5 000">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-budget')">ZruÅ¡it</button>
      <button class="btn btn-primary" id="bud-save-btn" onclick="saveBudget()">UloÅ¾it rozpoÄet</button>
    </div>
  </div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" id="modal-goal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="goal-modal-title">NovÃ½ spoÅ™icÃ­ cÃ­l</div>
      <button class="modal-close" onclick="closeModal('modal-goal')">Ã—</button>
    </div>
    <input type="hidden" id="goal-edit-id" value="">
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">NÃ¡zev cÃ­le</label>
        <input class="form-input" id="goal-name" placeholder="napÅ™. DovolenÃ¡">
      </div>
      <div class="form-group">
        <label class="form-label">Emoji</label>
        <input class="form-input" id="goal-emoji" placeholder="ğŸ¯" style="font-size:20px;">
      </div>
    </div>
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">CÃ­lovÃ¡ ÄÃ¡stka (KÄ)</label>
        <input class="form-input" type="number" id="goal-target" placeholder="50 000">
      </div>
      <div class="form-group">
        <label class="form-label">NaspoÅ™eno dosud (KÄ)</label>
        <input class="form-input" type="number" id="goal-current" placeholder="0">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">TermÃ­n splnÄ›nÃ­</label>
      <input class="form-input" type="date" id="goal-deadline">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-goal')">ZruÅ¡it</button>
      <button class="btn btn-primary" id="goal-save-btn" onclick="saveGoal()">VytvoÅ™it cÃ­l</button>
    </div>
  </div>
</div>

<!-- Investment Modal -->
<div class="modal-overlay" id="modal-investment">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="inv-modal-title">PÅ™idat aktivum</div>
      <button class="modal-close" onclick="closeModal('modal-investment')">Ã—</button>
    </div>
    <input type="hidden" id="inv-edit-id" value="">
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">NÃ¡zev aktiva</label>
        <input class="form-input" id="inv-name" placeholder="napÅ™. S&P 500 ETF">
      </div>
      <div class="form-group">
        <label class="form-label">Ticker / zkratka</label>
        <input class="form-input" id="inv-ticker" placeholder="SPY" style="text-transform:uppercase;">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Typ aktiva</label>
      <select class="form-select" id="inv-type">
        <option value="etf">ğŸ“Š ETF / Fond</option>
        <option value="stock">ğŸ“ˆ Akcie</option>
        <option value="crypto">â‚¿ KryptomÄ›na</option>
        <option value="pension">ğŸ¦ PenzijnÃ­ spoÅ™enÃ­</option>
        <option value="real-estate">ğŸ  Nemovitost</option>
        <option value="other">ğŸ’¼ JinÃ©</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">PoÄet kusÅ¯ / jednotek</label>
      <input class="form-input" type="number" id="inv-quantity" placeholder="10" step="any">
    </div>

    <!-- Exchange rates row -->
    <div style="background:var(--bg3);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:16px;display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
      <span style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em;flex-shrink:0;">Kurzy pro pÅ™epoÄet:</span>
      <label style="font-size:13px;color:var(--text2);display:flex;align-items:center;gap:6px;">
        1 USD =
        <input type="number" id="rate-usd" value="23.5" step="0.1" min="1"
          style="width:70px;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:13px;">
        KÄ
      </label>
      <label style="font-size:13px;color:var(--text2);display:flex;align-items:center;gap:6px;">
        1 EUR =
        <input type="number" id="rate-eur" value="25.2" step="0.1" min="1"
          style="width:70px;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:13px;">
        KÄ
      </label>
    </div>

    <div class="input-row">
      <div class="form-group">
        <label class="form-label">NÃ¡kupnÃ­ cena / kus</label>
        <div style="display:flex;gap:8px;">
          <input class="form-input" type="number" id="inv-buy-price" placeholder="2 500" step="any" style="flex:1;">
          <select class="form-select" id="inv-buy-currency" style="width:80px;padding:10px 8px;">
            <option value="CZK">KÄ</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">AktuÃ¡lnÃ­ cena / kus</label>
        <div style="display:flex;gap:8px;">
          <input class="form-input" type="number" id="inv-current-price" placeholder="2 800" step="any" style="flex:1;">
          <select class="form-select" id="inv-current-currency" style="width:80px;padding:10px 8px;">
            <option value="CZK">KÄ</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Live conversion preview -->
    <div id="inv-conversion-preview" style="font-size:12px;color:var(--text3);margin-top:-8px;margin-bottom:16px;padding:8px 12px;background:var(--bg3);border-radius:8px;display:none;"></div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-investment')">ZruÅ¡it</button>
      <button class="btn btn-primary" id="inv-save-btn" onclick="saveInvestment()">PÅ™idat aktivum</button>
    </div>
  </div>
</div>

<!-- Cashflow Modal -->
<div class="modal-overlay" id="modal-cashflow">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="cf-modal-title">NovÃ¡ poloÅ¾ka</div>
      <button class="modal-close" onclick="closeModal('modal-cashflow')">Ã—</button>
    </div>
    <input type="hidden" id="cf-edit-id" value="">
    <input type="hidden" id="cf-item-type" value="income">

    <div class="form-group">
      <label class="form-label">NÃ¡zev</label>
      <input class="form-input" id="cf-name" placeholder="napÅ™. VÃ½plata, NÃ¡jem, JÃ­dlo...">
    </div>

    <div class="input-row">
      <div class="form-group">
        <label class="form-label" id="cf-amount-label">ÄŒÃ¡stka (KÄ / mÄ›sÃ­c)</label>
        <input class="form-input" type="number" id="cf-amount" placeholder="0" min="0" oninput="updateCfPreview()">
      </div>
      <div class="form-group">
        <label class="form-label">Frekvence</label>
        <select class="form-select" id="cf-frequency" onchange="updateCfPreview()">
          <option value="monthly">MÄ›sÃ­ÄnÄ›</option>
          <option value="weekly">TÃ½dnÄ›</option>
          <option value="quarterly">ÄŒtvrtletnÄ›</option>
          <option value="yearly">RoÄnÄ›</option>
        </select>
      </div>
    </div>

    <!-- Variable limit field â€“ shown only for variable type -->
    <div class="form-group" id="cf-limit-group" style="display:none;">
      <label class="form-label">MÄ›sÃ­ÄnÃ­ limit (KÄ) <span style="color:var(--text3);font-weight:300;">â€“ maximÃ¡lnÃ­ povolenÃ¡ Ãºtrata</span></label>
      <input class="form-input" type="number" id="cf-limit" placeholder="napÅ™. 8 000" min="0">
    </div>

    <!-- Saving goal link â€“ shown only for saving type -->
    <div class="form-group" id="cf-goal-group" style="display:none;">
      <label class="form-label">Propojit se spoÅ™icÃ­m cÃ­lem <span style="color:var(--text3);font-weight:300;">(nepovinnÃ©)</span></label>
      <select class="form-select" id="cf-goal-link">
        <option value="">â€” bez propojenÃ­ â€”</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Kategorie</label>
      <select class="form-select" id="cf-category"></select>
    </div>

    <div class="input-row">
      <div class="form-group">
        <label class="form-label">Den v mÄ›sÃ­ci <span style="color:var(--text3);font-weight:300;">(splatnost / vÃ½plata)</span></label>
        <input class="form-input" type="number" id="cf-day" placeholder="1â€“31" min="1" max="31">
      </div>
      <div class="form-group">
        <label class="form-label">PoznÃ¡mka</label>
        <input class="form-input" id="cf-note" placeholder="VolitelnÃ¡...">
      </div>
    </div>

    <!-- Monthly equivalent preview -->
    <div id="cf-amount-preview" style="display:none;background:var(--bg3);border-radius:var(--radius-sm);padding:10px 14px;font-size:13px;color:var(--text2);margin-bottom:4px;"></div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-cashflow')">ZruÅ¡it</button>
      <button class="btn btn-primary" id="cf-save-btn" onclick="saveCashflowItem()">UloÅ¾it</button>
    </div>
  </div>
</div>

<!-- Bond Edit Modal -->
<div class="modal-overlay" id="modal-bond">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="bond-modal-title">Upravit investici</div>
      <button class="modal-close" onclick="closeModal('modal-bond')">Ã—</button>
    </div>
    <input type="hidden" id="bond-edit-id" value="">
    
    <div class="form-group">
      <label class="form-label">NÃ¡zev investice</label>
      <input class="form-input" type="text" id="bond-modal-name" placeholder="napÅ™. StÃ¡tnÃ­ dluhopis 2029">
    </div>
    
    <div class="form-group">
      <label class="form-label">Typ investice</label>
      <select class="form-select" id="bond-modal-category">
        <option value="bond">ğŸ“œ StÃ¡tnÃ­/firemnÃ­ dluhopis</option>
        <option value="deposit">ğŸ¦ TermÃ­novanÃ½ vklad</option>
        <option value="platform">ğŸ¢ InvestiÄnÃ­ platforma</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="form-label">PoÄÃ¡teÄnÃ­ investice (KÄ)</label>
      <input class="form-input" type="number" id="bond-modal-principal" placeholder="100 000" min="0" step="1000">
    </div>
    
    <div class="input-row">
      <div class="form-group">
        <label class="form-label">Datum nÃ¡kupu</label>
        <input class="form-input" type="date" id="bond-modal-purchase-date">
      </div>
      <div class="form-group">
        <label class="form-label">Doba splatnosti (roky)</label>
        <input class="form-input" type="number" id="bond-modal-years" placeholder="5" min="1" max="30" step="1">
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">RoÄnÃ­ ÃºrokovÃ¡ sazba (%)</label>
      <input class="form-input" type="number" id="bond-modal-rate" placeholder="4.5" min="0" max="20" step="0.1">
    </div>
    
    <div class="form-group">
      <label class="form-label">Typ ÃºroÄenÃ­</label>
      <select class="form-select" id="bond-modal-type">
        <option value="simple">ProstÃ© ÃºroÄenÃ­</option>
        <option value="compound">SloÅ¾enÃ© ÃºroÄenÃ­</option>
      </select>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-bond')">ZruÅ¡it</button>
      <button class="btn btn-primary" onclick="saveBondFromModal()">UloÅ¾it zmÄ›ny</button>
    </div>
  </div>
</div>

<!-- API Key Modal -->
<div class="modal-overlay" id="modal-apikey">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">NastavenÃ­ API klÃ­Äe</div>
      <button class="modal-close" onclick="closeModal('modal-apikey')">Ã—</button>
    </div>
    <p style="font-size:14px;color:var(--text2);line-height:1.7;margin-bottom:20px;">
      Pro automatickÃ© naÄÃ­tÃ¡nÃ­ cen aktiv je potÅ™eba Anthropic API klÃ­Ä. KlÃ­Ä se uklÃ¡dÃ¡ pouze lokÃ¡lnÄ› ve vaÅ¡em prohlÃ­Å¾eÄi a nikam se neodesÃ­lÃ¡.
    </p>
    <div class="form-group">
      <label class="form-label">Anthropic API klÃ­Ä</label>
      <input class="form-input" type="password" id="apikey-input" placeholder="sk-ant-...">
    </div>
    <p style="font-size:12px;color:var(--text3);margin-top:-8px;">
      KlÃ­Ä zÃ­skÃ¡te na <strong style="color:var(--gold2);">console.anthropic.com</strong>
    </p>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-apikey')">ZruÅ¡it</button>
      <button class="btn btn-primary" onclick="saveApiKey()">UloÅ¾it a naÄÃ­st ceny</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA LAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = 'penezenka_v1';

const CATEGORIES = [
  { id:'food', name:'JÃ­dlo & nÃ¡kupy', emoji:'ğŸ›’', color:'#e8c97a' },
  { id:'housing', name:'BydlenÃ­', emoji:'ğŸ ', color:'#5b9bd5' },
  { id:'transport', name:'Doprava', emoji:'ğŸš—', color:'#8b7fd5' },
  { id:'health', name:'ZdravÃ­', emoji:'ğŸ’Š', color:'#4caf78' },
  { id:'entertainment', name:'ZÃ¡bava', emoji:'ğŸ¬', color:'#d55b9b' },
  { id:'clothing', name:'ObleÄenÃ­', emoji:'ğŸ‘—', color:'#d5835b' },
  { id:'education', name:'VzdÄ›lÃ¡nÃ­', emoji:'ğŸ“š', color:'#5bd5c7' },
  { id:'sport', name:'Sport', emoji:'ğŸƒ', color:'#7fd55b' },
  { id:'travel', name:'CestovÃ¡nÃ­', emoji:'âœˆï¸', color:'#d5c35b' },
  { id:'investments', name:'Investice', emoji:'ğŸ“ˆ', color:'#c9a84c' },
  { id:'income', name:'PÅ™Ã­jem', emoji:'ğŸ’°', color:'#4caf78' },
  { id:'other', name:'OstatnÃ­', emoji:'ğŸ“¦', color:'#6b6560' },
];

const ACC_ICONS = { bank:'ğŸ¦', savings:'ğŸ’°', cash:'ğŸ’µ', credit:'ğŸ’³', invest:'ğŸ“ˆ' };

function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  const defaults = {
    accounts: [],
    transactions: [],
    budgets: [],
    goals: [],
    investments: [],
    cashflow: [],
    bonds: []
  };
  if (!raw) return defaults;
  try { return { ...defaults, ...JSON.parse(raw) }; }
  catch { return defaults; }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

let db = loadData();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick')?.includes(page)) n.classList.add('active');
  });
  if (page === 'dashboard') renderDashboard();
  if (page === 'transactions') renderTransactions();
  if (page === 'accounts') renderAccounts();
  if (page === 'budgets') renderBudgets();
  if (page === 'goals') renderGoals();
  if (page === 'investments') { renderInvestments(); fetchPricesIfPossible(); }
  if (page === 'cashflow') renderCashflow();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openModal(id) {
  if (id === 'modal-transaction') setupTransactionModal();
  if (id === 'modal-budget') setupBudgetModal();
  if (id === 'modal-cashflow') {
    // preview wire-up
    setTimeout(() => {
      document.getElementById('cf-amount')?.addEventListener('input', updateCfPreview);
      document.getElementById('cf-frequency')?.addEventListener('change', updateCfPreview);
    }, 50);
  }
  if (id === 'modal-apikey') {
    const existing = getApiKey();
    document.getElementById('apikey-input').value = existing || '';
  }
  if (id === 'modal-investment') {
    const editId = document.getElementById('inv-edit-id').value;
    if (!editId) {
      // Reset to "add" mode
      document.getElementById('inv-modal-title').textContent = 'PÅ™idat aktivum';
      document.getElementById('inv-save-btn').textContent = 'PÅ™idat aktivum';
      document.getElementById('inv-name').value = '';
      document.getElementById('inv-ticker').value = '';
      document.getElementById('inv-type').value = 'etf';
      document.getElementById('inv-quantity').value = '';
      document.getElementById('inv-buy-price').value = '';
      document.getElementById('inv-buy-currency').value = 'CZK';
      document.getElementById('inv-current-price').value = '';
      document.getElementById('inv-current-currency').value = 'CZK';
      document.getElementById('inv-conversion-preview').style.display = 'none';
    }
  }
  document.getElementById(id).classList.add('open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  if (id === 'modal-investment') document.getElementById('inv-edit-id').value = '';
  if (id === 'modal-bond') document.getElementById('bond-edit-id').value = '';
  if (id === 'modal-transaction') {
    document.getElementById('tx-edit-id').value = '';
    document.getElementById('tx-modal-title').textContent = 'NovÃ¡ transakce';
    document.getElementById('tx-save-btn').textContent = 'UloÅ¾it transakci';
  }
  if (id === 'modal-account') {
    document.getElementById('acc-edit-id').value = '';
    document.getElementById('acc-modal-title').textContent = 'NovÃ½ ÃºÄet';
    document.getElementById('acc-save-btn').textContent = 'PÅ™idat ÃºÄet';
  }
  if (id === 'modal-budget') {
    document.getElementById('bud-edit-id').value = '';
    document.getElementById('bud-modal-title').textContent = 'NovÃ½ rozpoÄet';
    document.getElementById('bud-save-btn').textContent = 'UloÅ¾it rozpoÄet';
  }
  if (id === 'modal-goal') {
    document.getElementById('goal-edit-id').value = '';
    document.getElementById('goal-modal-title').textContent = 'NovÃ½ spoÅ™icÃ­ cÃ­l';
    document.getElementById('goal-save-btn').textContent = 'VytvoÅ™it cÃ­l';
  }
}

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

function setupTransactionModal() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tx-date').value = today;
  document.getElementById('tx-amount').value = '';
  document.getElementById('tx-name').value = '';
  document.getElementById('tx-note').value = '';

  const catSel = document.getElementById('tx-category');
  catSel.innerHTML = CATEGORIES.map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');

  const accSel = document.getElementById('tx-account');
  accSel.innerHTML = db.accounts.length
    ? db.accounts.map(a => `<option value="${a.id}">${ACC_ICONS[a.type]} ${a.name}</option>`).join('')
    : '<option value="">â€” Å½Ã¡dnÃ© ÃºÄty â€”</option>';
}

function setupBudgetModal() {
  const sel = document.getElementById('bud-category');
  sel.innerHTML = CATEGORIES.filter(c => c.id !== 'income').map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');
}

function setTxType(type) {
  document.getElementById('tx-type-val').value = type;
  document.querySelectorAll('#tx-type-toggle .toggle-btn').forEach((btn, i) => {
    btn.classList.toggle('active', ['expense','income','transfer'][i] === type);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,5); }

// â”€â”€ TRANSACTIONS â”€â”€
function editTransaction(id) {
  const t = db.transactions.find(t => t.id === id);
  if (!t) return;
  setupTransactionModal();
  document.getElementById('tx-edit-id').value = id;
  document.getElementById('tx-modal-title').textContent = 'Upravit transakci';
  document.getElementById('tx-save-btn').textContent = 'UloÅ¾it zmÄ›ny';
  document.getElementById('tx-amount').value = t.amount;
  document.getElementById('tx-date').value = t.date;
  document.getElementById('tx-name').value = t.name;
  document.getElementById('tx-note').value = t.note || '';
  document.getElementById('tx-category').value = t.category;
  document.getElementById('tx-account').value = t.account;
  setTxType(t.type);
  document.getElementById('modal-transaction').classList.add('open');
}

function saveTransaction() {
  const amount = parseFloat(document.getElementById('tx-amount').value);
  const name = document.getElementById('tx-name').value.trim();
  if (!amount || amount <= 0) { toast('Zadejte platnou ÄÃ¡stku', 'error'); return; }
  if (!name) { toast('Zadejte nÃ¡zev transakce', 'error'); return; }
  const editId = document.getElementById('tx-edit-id').value;
  const data = {
    type: document.getElementById('tx-type-val').value,
    amount, name,
    date: document.getElementById('tx-date').value,
    category: document.getElementById('tx-category').value,
    account: document.getElementById('tx-account').value,
    note: document.getElementById('tx-note').value
  };
  if (editId) {
    const idx = db.transactions.findIndex(t => t.id === editId);
    if (idx >= 0) db.transactions[idx] = { ...db.transactions[idx], ...data };
    toast('Transakce upravena âœ“', 'success');
  } else {
    db.transactions.push({ id: uid(), ...data });
    toast('Transakce uloÅ¾ena âœ“', 'success');
  }
  saveData(db);
  closeModal('modal-transaction');
  renderDashboard();
  renderTransactions();
}

function deleteTransaction(id) {
  db.transactions = db.transactions.filter(t => t.id !== id);
  saveData(db);
  renderDashboard();
  renderTransactions();
  toast('Transakce smazÃ¡na');
}

// â”€â”€ ACCOUNTS â”€â”€
function editAccount(id) {
  const a = db.accounts.find(a => a.id === id);
  if (!a) return;
  document.getElementById('acc-edit-id').value = id;
  document.getElementById('acc-modal-title').textContent = 'Upravit ÃºÄet';
  document.getElementById('acc-save-btn').textContent = 'UloÅ¾it zmÄ›ny';
  document.getElementById('acc-name').value = a.name;
  document.getElementById('acc-type').value = a.type;
  document.getElementById('acc-balance').value = a.initialBalance;
  document.getElementById('modal-account').classList.add('open');
}

function saveAccount() {
  const name = document.getElementById('acc-name').value.trim();
  if (!name) { toast('Zadejte nÃ¡zev ÃºÄtu', 'error'); return; }
  const editId = document.getElementById('acc-edit-id').value;
  const data = {
    name,
    type: document.getElementById('acc-type').value,
    initialBalance: parseFloat(document.getElementById('acc-balance').value) || 0
  };
  if (editId) {
    const idx = db.accounts.findIndex(a => a.id === editId);
    if (idx >= 0) db.accounts[idx] = { ...db.accounts[idx], ...data };
    toast('ÃšÄet upraven âœ“', 'success');
  } else {
    db.accounts.push({ id: uid(), ...data });
    toast('ÃšÄet pÅ™idÃ¡n âœ“', 'success');
  }
  saveData(db);
  closeModal('modal-account');
  renderAccounts();
  renderDashboard();
}

function deleteAccount(id) {
  db.accounts = db.accounts.filter(a => a.id !== id);
  saveData(db);
  renderAccounts();
  renderDashboard();
  toast('ÃšÄet smazÃ¡n');
}

// â”€â”€ BUDGETS â”€â”€
function editBudget(id) {
  const b = db.budgets.find(b => b.id === id);
  if (!b) return;
  setupBudgetModal();
  document.getElementById('bud-edit-id').value = id;
  document.getElementById('bud-modal-title').textContent = 'Upravit rozpoÄet';
  document.getElementById('bud-save-btn').textContent = 'UloÅ¾it zmÄ›ny';
  document.getElementById('bud-category').value = b.category;
  document.getElementById('bud-limit').value = b.limit;
  document.getElementById('modal-budget').classList.add('open');
}

function saveBudget() {
  const cat = document.getElementById('bud-category').value;
  const limit = parseFloat(document.getElementById('bud-limit').value);
  if (!limit || limit <= 0) { toast('Zadejte platnÃ½ limit', 'error'); return; }
  const editId = document.getElementById('bud-edit-id').value;
  if (editId) {
    const idx = db.budgets.findIndex(b => b.id === editId);
    if (idx >= 0) { db.budgets[idx].limit = limit; db.budgets[idx].category = cat; }
    toast('RozpoÄet upraven âœ“', 'success');
  } else {
    const existing = db.budgets.findIndex(b => b.category === cat);
    if (existing >= 0) db.budgets[existing].limit = limit;
    else db.budgets.push({ id: uid(), category: cat, limit });
    toast('RozpoÄet uloÅ¾en âœ“', 'success');
  }
  saveData(db);
  closeModal('modal-budget');
  renderBudgets();
  renderDashboard();
}

function deleteBudget(id) {
  db.budgets = db.budgets.filter(b => b.id !== id);
  saveData(db);
  renderBudgets();
  renderDashboard();
  toast('RozpoÄet smazÃ¡n');
}

// â”€â”€ GOALS â”€â”€
function editGoal(id) {
  const g = db.goals.find(g => g.id === id);
  if (!g) return;
  document.getElementById('goal-edit-id').value = id;
  document.getElementById('goal-modal-title').textContent = 'Upravit cÃ­l';
  document.getElementById('goal-save-btn').textContent = 'UloÅ¾it zmÄ›ny';
  document.getElementById('goal-name').value = g.name;
  document.getElementById('goal-emoji').value = g.emoji;
  document.getElementById('goal-target').value = g.target;
  document.getElementById('goal-current').value = g.current;
  document.getElementById('goal-deadline').value = g.deadline || '';
  document.getElementById('modal-goal').classList.add('open');
}

function saveGoal() {
  const name = document.getElementById('goal-name').value.trim();
  const target = parseFloat(document.getElementById('goal-target').value);
  if (!name) { toast('Zadejte nÃ¡zev cÃ­le', 'error'); return; }
  if (!target || target <= 0) { toast('Zadejte cÃ­lovou ÄÃ¡stku', 'error'); return; }
  const editId = document.getElementById('goal-edit-id').value;
  const data = {
    name,
    emoji: document.getElementById('goal-emoji').value || 'ğŸ¯',
    target,
    current: parseFloat(document.getElementById('goal-current').value) || 0,
    deadline: document.getElementById('goal-deadline').value
  };
  if (editId) {
    const idx = db.goals.findIndex(g => g.id === editId);
    if (idx >= 0) db.goals[idx] = { ...db.goals[idx], ...data };
    toast('CÃ­l upraven âœ“', 'success');
  } else {
    db.goals.push({ id: uid(), ...data });
    toast('CÃ­l vytvoÅ™en âœ“', 'success');
  }
  saveData(db);
  closeModal('modal-goal');
  renderGoals();
}

function deleteGoal(id) {
  db.goals = db.goals.filter(g => g.id !== id);
  saveData(db);
  renderGoals();
  toast('CÃ­l smazÃ¡n');
}

function toCZK(amount, currency) {
  if (!amount) return 0;
  const rateUSD = parseFloat(document.getElementById('rate-usd')?.value) || 23.5;
  const rateEUR = parseFloat(document.getElementById('rate-eur')?.value) || 25.2;
  if (currency === 'USD') return amount * rateUSD;
  if (currency === 'EUR') return amount * rateEUR;
  return amount; // already CZK
}

function updateConversionPreview() {
  const preview = document.getElementById('inv-conversion-preview');
  if (!preview) return;
  const buyVal = parseFloat(document.getElementById('inv-buy-price').value);
  const buyCur = document.getElementById('inv-buy-currency').value;
  const curVal = parseFloat(document.getElementById('inv-current-price').value);
  const curCur = document.getElementById('inv-current-currency').value;

  const parts = [];
  if (buyVal && buyCur !== 'CZK') {
    parts.push(`NÃ¡kupnÃ­: ${buyVal} ${buyCur} â†’ ${Math.round(toCZK(buyVal, buyCur)).toLocaleString('cs-CZ')} KÄ`);
  }
  if (curVal && curCur !== 'CZK') {
    parts.push(`AktuÃ¡lnÃ­: ${curVal} ${curCur} â†’ ${Math.round(toCZK(curVal, curCur)).toLocaleString('cs-CZ')} KÄ`);
  }

  if (parts.length) {
    preview.textContent = 'â‡„ ' + parts.join('   Â·   ');
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

function editInvestment(id) {
  const inv = db.investments.find(i => i.id === id);
  if (!inv) return;

  document.getElementById('inv-modal-title').textContent = 'Upravit aktivum';
  document.getElementById('inv-save-btn').textContent = 'UloÅ¾it zmÄ›ny';
  document.getElementById('inv-edit-id').value = id;
  document.getElementById('inv-name').value = inv.name;
  document.getElementById('inv-ticker').value = inv.ticker;
  document.getElementById('inv-type').value = inv.type;
  document.getElementById('inv-quantity').value = inv.quantity;
  document.getElementById('inv-buy-price').value = inv.buyPrice;
  document.getElementById('inv-buy-currency').value = 'CZK';
  document.getElementById('inv-current-price').value = inv.currentPrice;
  document.getElementById('inv-current-currency').value = 'CZK';
  if (inv.rateUSD) document.getElementById('rate-usd').value = inv.rateUSD;
  if (inv.rateEUR) document.getElementById('rate-eur').value = inv.rateEUR;
  updateConversionPreview();

  openModal('modal-investment');
}

function saveInvestment() {
  const name = document.getElementById('inv-name').value.trim();
  const qty = parseFloat(document.getElementById('inv-quantity').value);
  const buyRaw = parseFloat(document.getElementById('inv-buy-price').value);
  const buyCur = document.getElementById('inv-buy-currency').value;
  const curRaw = parseFloat(document.getElementById('inv-current-price').value);
  const curCur = document.getElementById('inv-current-currency').value;
  const editId = document.getElementById('inv-edit-id').value;
  const rateUSD = parseFloat(document.getElementById('rate-usd').value) || 23.5;
  const rateEUR = parseFloat(document.getElementById('rate-eur').value) || 25.2;

  if (!name) { toast('Zadejte nÃ¡zev aktiva', 'error'); return; }
  if (!qty || !buyRaw) { toast('Zadejte mnoÅ¾stvÃ­ a nÃ¡kupnÃ­ cenu', 'error'); return; }

  const buyPrice = toCZK(buyRaw, buyCur);
  const currentPrice = curRaw ? toCZK(curRaw, curCur) : buyPrice;

  const data = {
    name,
    ticker: document.getElementById('inv-ticker').value.toUpperCase() || name.slice(0,4).toUpperCase(),
    type: document.getElementById('inv-type').value,
    quantity: qty,
    buyPrice: Math.round(buyPrice * 100) / 100,
    currentPrice: Math.round(currentPrice * 100) / 100,
    rateUSD,
    rateEUR
  };

  if (editId) {
    const inv = db.investments.find(i => i.id === editId);
    if (inv) Object.assign(inv, data);
    toast('Aktivum upraveno âœ“', 'success');
  } else {
    db.investments.push({ id: uid(), ...data });
    toast('Aktivum pÅ™idÃ¡no âœ“', 'success');
  }

  saveData(db);
  closeModal('modal-investment');
  renderInvestments();
}

function deleteInvestment(id) {
  db.investments = db.investments.filter(i => i.id !== id);
  saveData(db);
  renderInvestments();
  toast('Aktivum smazÃ¡no');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fmt(n) {
  return new Intl.NumberFormat('cs-CZ', { style:'decimal', minimumFractionDigits:0, maximumFractionDigits:0 }).format(n) + ' KÄ';
}

function fmtShort(n) {
  if (Math.abs(n) >= 1000000) return (n/1000000).toFixed(1) + ' mil. KÄ';
  if (Math.abs(n) >= 10000) return Math.round(n/1000) + ' tis. KÄ';
  return fmt(n);
}

function getCategory(id) { return CATEGORIES.find(c => c.id === id) || CATEGORIES[CATEGORIES.length-1]; }

function accountBalance(accId) {
  const acc = db.accounts.find(a => a.id === accId);
  if (!acc) return 0;
  const txs = db.transactions.filter(t => t.account === accId);
  const delta = txs.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : t.type === 'expense' ? -t.amount : 0), 0);
  return acc.initialBalance + delta;
}

function thisMonthTx() {
  const now = new Date();
  return db.transactions.filter(t => {
    const d = new Date(t.date);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let cashflowChart, categoryChart;

function renderDashboard() {
  const now = new Date();
  document.getElementById('dashboard-date').textContent = now.toLocaleDateString('cs-CZ', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // Stats
  const totalBalance = db.accounts.reduce((s,a) => s + accountBalance(a.id), 0);
  document.getElementById('dash-balance').textContent = fmt(totalBalance);

  const monthly = thisMonthTx();
  const income = monthly.filter(t => t.type === 'income').reduce((s,t) => s+t.amount, 0);
  const expenses = monthly.filter(t => t.type === 'expense').reduce((s,t) => s+t.amount, 0);
  document.getElementById('dash-income').textContent = fmt(income);
  document.getElementById('dash-expenses').textContent = fmt(expenses);
  document.getElementById('dash-income-count').textContent = monthly.filter(t => t.type==='income').length + ' transakcÃ­';
  document.getElementById('dash-expense-count').textContent = monthly.filter(t => t.type==='expense').length + ' transakcÃ­';

  const invTotal = db.investments.reduce((s,i) => s + i.quantity*i.currentPrice, 0);
  const invBuy = db.investments.reduce((s,i) => s + i.quantity*i.buyPrice, 0);
  document.getElementById('dash-portfolio').textContent = fmt(invTotal);
  document.getElementById('dash-portfolio-gain').textContent = (invTotal-invBuy >= 0 ? '+' : '') + fmt(invTotal-invBuy) + ' zisk';

  // Recent transactions
  const recent = [...db.transactions].sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0,5);
  const recentEl = document.getElementById('dash-recent-tx');
  if (!recent.length) {
    recentEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">â‡„</div><div class="empty-state-text">ZatÃ­m Å¾Ã¡dnÃ© transakce</div></div>`;
  } else {
    recentEl.innerHTML = recent.map(t => txItemHTML(t)).join('');
  }

  // Budgets preview
  const budgetsEl = document.getElementById('dash-budgets-preview');
  if (!db.budgets.length) {
    budgetsEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">â—·</div><div class="empty-state-text">Å½Ã¡dnÃ© rozpoÄty</div></div>`;
  } else {
    budgetsEl.innerHTML = db.budgets.slice(0,4).map(b => budgetItemHTML(b, false)).join('');
  }

  // Cashflow chart (last 6 months)
  const months = [];
  const incomeData = [], expenseData = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toLocaleDateString('cs-CZ', { month:'short' }));
    const mTx = db.transactions.filter(t => {
      const td = new Date(t.date);
      return td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear();
    });
    incomeData.push(mTx.filter(t => t.type==='income').reduce((s,t) => s+t.amount, 0));
    expenseData.push(mTx.filter(t => t.type==='expense').reduce((s,t) => s+t.amount, 0));
  }

  if (cashflowChart) cashflowChart.destroy();
  const cfCtx = document.getElementById('chart-cashflow').getContext('2d');
  cashflowChart = new Chart(cfCtx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label:'PÅ™Ã­jmy', data: incomeData, backgroundColor:'rgba(76,175,120,0.7)', borderRadius:6 },
        { label:'VÃ½daje', data: expenseData, backgroundColor:'rgba(224,92,92,0.7)', borderRadius:6 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend:{ labels:{ color:'#a09890', font:{family:'IBM Plex Sans', size:12} } } },
      scales: {
        x: { ticks:{ color:'#6b6560' }, grid:{ color:'rgba(255,255,255,0.04)' } },
        y: { ticks:{ color:'#6b6560', callback: v => v >= 1000 ? Math.round(v/1000)+'k' : v }, grid:{ color:'rgba(255,255,255,0.04)' } }
      }
    }
  });

  // Category donut
  const catTotals = {};
  monthly.filter(t => t.type==='expense').forEach(t => {
    catTotals[t.category] = (catTotals[t.category]||0) + t.amount;
  });
  const catLabels = Object.keys(catTotals).map(id => getCategory(id).emoji + ' ' + getCategory(id).name);
  const catValues = Object.values(catTotals);
  const catColors = Object.keys(catTotals).map(id => getCategory(id).color);

  if (categoryChart) categoryChart.destroy();
  const catCtx = document.getElementById('chart-categories').getContext('2d');
  if (catValues.length) {
    categoryChart = new Chart(catCtx, {
      type: 'doughnut',
      data: { labels: catLabels, datasets:[{ data: catValues, backgroundColor: catColors, borderWidth:0, hoverOffset:6 }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        cutout:'65%',
        plugins:{ legend:{ display:false } }
      }
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTransactions() {
  // Populate filter
  const catFilter = document.getElementById('tx-filter-cat');
  catFilter.innerHTML = '<option value="">VÅ¡echny kategorie</option>' +
    CATEGORIES.map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');

  const search = (document.getElementById('tx-search')?.value || '').toLowerCase();
  const typeFilter = document.getElementById('tx-filter-type')?.value || '';
  const catFilterVal = catFilter.value || '';

  let txs = [...db.transactions].sort((a,b) => new Date(b.date)-new Date(a.date));
  if (search) txs = txs.filter(t => t.name.toLowerCase().includes(search) || (t.note||'').toLowerCase().includes(search));
  if (typeFilter) txs = txs.filter(t => t.type === typeFilter);
  if (catFilterVal) txs = txs.filter(t => t.category === catFilterVal);

  const container = document.getElementById('tx-list-container');
  if (!txs.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">â‡„</div><div class="empty-state-text">Å½Ã¡dnÃ© transakce neodpovÃ­dajÃ­ filtru</div></div>`;
    return;
  }

  // Group by date
  const groups = {};
  txs.forEach(t => {
    if (!groups[t.date]) groups[t.date] = [];
    groups[t.date].push(t);
  });

  container.innerHTML = Object.entries(groups).map(([date, items]) => {
    const d = new Date(date);
    const label = d.toLocaleDateString('cs-CZ', { weekday:'long', day:'numeric', month:'long' });
    const dayTotal = items.reduce((s,t) => s + (t.type==='income'?t.amount:t.type==='expense'?-t.amount:0), 0);
    return `
      <div style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:0 4px;">
          <span style="font-size:12px;color:var(--text3);text-transform:capitalize;">${label}</span>
          <span style="font-size:13px;font-weight:500;color:${dayTotal>=0?'var(--green)':'var(--red)'};">${dayTotal>=0?'+':''}${fmt(dayTotal)}</span>
        </div>
        ${items.map(t => txItemHTML(t, true)).join('')}
      </div>`;
  }).join('');
  
  // Initialize swipe gestures
  document.querySelectorAll('.tx-item.swipe-container').forEach(item => {
    const txId = item.dataset.txId;
    initSwipe(
      item,
      () => editTransaction(txId),
      () => deleteTransaction(txId)
    );
  });
}

function txItemHTML(t, showDelete=false) {
  const cat = getCategory(t.category);
  const isIncome = t.type === 'income';
  const acc = db.accounts.find(a => a.id === t.account);
  return `<div class="tx-item swipe-container" data-tx-id="${t.id}">
    <div class="swipe-actions swipe-actions-left">
      <div class="swipe-action edit" onclick="editTransaction('${t.id}')">âœï¸</div>
    </div>
    <div class="swipe-content" style="display:flex;align-items:center;gap:14px;padding:14px 16px;width:100%;">
      <div class="tx-icon" style="background:${cat.color}22; color:${cat.color};">${cat.emoji}</div>
      <div class="tx-info">
        <div class="tx-name">${t.name}</div>
        <div class="tx-meta">${cat.name}${acc ? ' Â· ' + acc.name : ''}${t.note ? ' Â· ' + t.note : ''}</div>
      </div>
      <div class="tx-amount ${t.type==='income'?'income':'expense'}">${isIncome?'+':'-'}${fmt(t.amount)}</div>
    </div>
    <div class="swipe-actions swipe-actions-right">
      <div class="swipe-action delete" onclick="deleteTransaction('${t.id}')">ğŸ—‘ï¸</div>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ACCOUNTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAccounts() {
  const grid = document.getElementById('accounts-grid');
  if (!db.accounts.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">â—»</div><div class="empty-state-text">PÅ™idejte svÅ¯j prvnÃ­ ÃºÄet</div></div>`;
    return;
  }
  grid.innerHTML = db.accounts.map(a => {
    const bal = accountBalance(a.id);
    return `<div class="account-card" onclick="editAccount('${a.id}')" style="cursor:pointer;" title="KliknÄ›te pro Ãºpravu">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div class="account-icon">${ACC_ICONS[a.type]}</div>
        <div style="display:flex;gap:4px;align-items:center;">
          <span style="font-size:11px;color:var(--text3);">âœ</span>
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteAccount('${a.id}')">ğŸ—‘</button>
        </div>
      </div>
      <div class="account-name">${a.name}</div>
      <div class="account-balance">${fmt(bal)}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER BUDGETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function budgetSpent(catId) {
  return thisMonthTx().filter(t => t.type==='expense' && t.category===catId).reduce((s,t) => s+t.amount, 0);
}

function budgetItemHTML(b, clickable=false) {
  const cat = getCategory(b.category);
  const spent = budgetSpent(b.category);
  const pct = Math.min((spent / b.limit)*100, 100);
  const color = pct >= 100 ? 'red' : pct >= 80 ? 'gold' : 'green';
  const remaining = b.limit - spent;
  const clickAttr = clickable ? `onclick="editBudget('${b.id}')" style="cursor:pointer;" title="KliknÄ›te pro Ãºpravu"` : '';
  return `<div class="budget-item" ${clickAttr}>
    <div class="budget-header">
      <div class="budget-name">${cat.emoji} ${cat.name}</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="budget-amounts"><strong>${fmt(spent)}</strong> / ${fmt(b.limit)}</div>
        ${clickable ? `<span style="font-size:11px;color:var(--text3);">âœ</span><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteBudget('${b.id}')">ğŸ—‘</button>` : ''}
      </div>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill ${color}" style="width:${pct}%;"></div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:12px;">
      <span style="color:var(--text3);">${pct.toFixed(0)}% vyÄerpÃ¡no</span>
      <span style="color:${remaining<0?'var(--red)':'var(--text3)'};">${remaining<0?'PÅ™ekroÄeno o '+fmt(-remaining):'ZbÃ½vÃ¡ '+fmt(remaining)}</span>
    </div>
  </div>`;
}

function renderBudgets() {
  const now = new Date();
  document.getElementById('budget-month-label').textContent =
    now.toLocaleDateString('cs-CZ', { month:'long', year:'numeric' });

  const list = document.getElementById('budgets-list');
  if (!db.budgets.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">â—·</div><div class="empty-state-text">PÅ™idejte svÅ¯j prvnÃ­ rozpoÄet</div></div>`;
    return;
  }
  list.innerHTML = db.budgets.map(b => budgetItemHTML(b, true)).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderGoals() {
  const grid = document.getElementById('goals-grid');
  if (!db.goals.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">â—</div><div class="empty-state-text">VytvoÅ™te svÅ¯j prvnÃ­ spoÅ™icÃ­ cÃ­l</div></div>`;
    return;
  }
  grid.innerHTML = db.goals.map(g => {
    const pct = Math.min((g.current/g.target)*100, 100);
    const remaining = g.target - g.current;
    let monthlyNeeded = null, monthsLeft = null;
    if (g.deadline) {
      const deadline = new Date(g.deadline);
      const now = new Date();
      monthsLeft = (deadline.getFullYear() - now.getFullYear()) * 12 + (deadline.getMonth() - now.getMonth());
      if (monthsLeft > 0) monthlyNeeded = remaining / monthsLeft;
    }
    const color = pct >= 100 ? 'green' : pct >= 60 ? 'gold' : 'blue';
    const deadlineStr = g.deadline ? new Date(g.deadline).toLocaleDateString('cs-CZ', {month:'long', year:'numeric'}) : 'Bez termÃ­nu';
    return `<div class="goal-card" onclick="editGoal('${g.id}')" style="cursor:pointer;" title="KliknÄ›te pro Ãºpravu">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div class="goal-emoji">${g.emoji}</div>
        <div style="display:flex;gap:4px;align-items:center;">
          <span style="font-size:11px;color:var(--text3);">âœ</span>
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteGoal('${g.id}')">ğŸ—‘</button>
        </div>
      </div>
      <div class="goal-name">${g.name}</div>
      <div class="goal-deadline">TermÃ­n: ${deadlineStr}</div>
      <div class="goal-amounts">
        <span class="goal-amount-current">${fmt(g.current)}</span>
        <span class="goal-amount-target">z ${fmt(g.target)}</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill ${color}" style="width:${pct}%;"></div>
        </div>
      </div>
      <div style="font-size:12px;color:var(--text3);margin-top:6px;">${pct.toFixed(0)}% splnÄ›no</div>
      ${monthlyNeeded && monthlyNeeded > 0 ? `<div class="goal-monthly">Pro splnÄ›nÃ­ cÃ­le spoÅ™te <strong>${fmt(monthlyNeeded)}/mÄ›sÃ­c</strong> (${monthsLeft} mÄ›s. zbÃ½vÃ¡)</div>` : pct >= 100 ? '<div class="goal-monthly" style="color:var(--green);">ğŸ‰ CÃ­l splnÄ›n!</div>' : ''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER INVESTMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let portfolioChart, projectionChart;
let activeScenario = 'all';

function renderInvestments() {
  const total = db.investments.reduce((s,i) => s + i.quantity * i.currentPrice, 0);
  const invested = db.investments.reduce((s,i) => s + i.quantity * i.buyPrice, 0);
  const gain = total - invested;
  const pct = invested > 0 ? (gain/invested*100) : 0;

  document.getElementById('inv-total').textContent = fmt(total);
  document.getElementById('inv-invested').textContent = fmt(invested);
  const gainEl = document.getElementById('inv-gain');
  gainEl.textContent = (gain >= 0 ? '+' : '') + fmt(gain);
  gainEl.style.color = gain >= 0 ? 'var(--green)' : 'var(--red)';
  const pctEl = document.getElementById('inv-pct');
  pctEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
  pctEl.style.color = pct >= 0 ? 'var(--green)' : 'var(--red)';

  const list = document.getElementById('inv-list');
  if (!db.investments.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">â—†</div><div class="empty-state-text">PÅ™idejte prvnÃ­ aktivum do portfolia</div></div>`;
  } else {
    list.innerHTML = db.investments.map(i => {
      const val = i.quantity * i.currentPrice;
      const buy = i.quantity * i.buyPrice;
      const g = val - buy;
      const gp = buy > 0 ? (g/buy*100) : 0;
      return `<div class="invest-item" onclick="editInvestment('${i.id}')" style="cursor:pointer;" title="KliknÄ›te pro Ãºpravu">
        <div class="invest-ticker">${i.ticker}</div>
        <div class="invest-info">
          <div class="invest-name">${i.name}</div>
          <div class="invest-detail">${i.quantity} ks Â· nÃ¡kup ${fmt(i.buyPrice)}/ks${i.priceSource ? ` Â· <span style="color:var(--green);font-size:11px;">â— ${i.priceSource}</span>` : ''}</div>
        </div>
        <div class="invest-value">
          <div class="invest-current">${fmt(val)}</div>
          <div class="invest-gain ${g>=0?'pos':'neg'}">${g>=0?'+':''}${fmt(g)} (${gp>=0?'+':''}${gp.toFixed(1)}%)</div>
        </div>
        <div style="display:flex;align-items:center;gap:4px;margin-left:8px;">
          <span style="font-size:12px;color:var(--text3);opacity:0.6;">âœ</span>
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteInvestment('${i.id}')">ğŸ—‘</button>
        </div>
      </div>`;
    }).join('');
  }

  // Portfolio treemap (grid-based like investment apps)
  const treemapEl = document.getElementById('portfolio-treemap');
  const ASSET_COLORS = { etf:'#c9a84c', stock:'#5b9bd5', crypto:'#f7931a', pension:'#4caf78', 'real-estate':'#8b7fd5', other:'#6b6560' };
  
  if (!db.investments.length) {
    treemapEl.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:14px;">ZatÃ­m Å¾Ã¡dnÃ¡ aktiva v portfoliu</div>`;
  } else {
    // Calculate values and changes
    const items = db.investments.map(i => {
      const val = i.quantity * i.currentPrice;
      const buy = i.quantity * i.buyPrice;
      const dailyChange = buy > 0 ? ((i.currentPrice - i.buyPrice) / i.buyPrice * 100) : 0;
      return { ...i, value: val, dailyChange };
    });
    
    const totalValue = items.reduce((s, i) => s + i.value, 0);
    items.sort((a, b) => b.value - a.value);
    
    // Assign grid sizes based on portfolio weight
    items.forEach(item => {
      const pct = (item.value / totalValue) * 100;
      if (pct >= 20) item.gridSize = 'large'; // 2x2
      else if (pct >= 10) item.gridSize = 'medium'; // 1x2 or 2x1
      else if (pct >= 5) item.gridSize = 'small'; // 1x1
      else item.gridSize = 'tiny'; // 1x1
    });
    
    // Create grid layout
    treemapEl.style.display = 'grid';
    treemapEl.style.gridTemplateColumns = 'repeat(4, 1fr)';
    treemapEl.style.gridAutoRows = '70px';
    treemapEl.style.gap = '6px';
    treemapEl.style.background = 'transparent';
    
    treemapEl.innerHTML = items.map(i => {
      const isPositive = i.dailyChange >= 0;
      const bgColor = isPositive 
        ? 'rgba(76, 175, 120, 0.12)'
        : 'rgba(224, 92, 92, 0.12)';
      
      let gridSpan = '';
      if (i.gridSize === 'large') gridSpan = 'grid-column: span 2; grid-row: span 2;';
      else if (i.gridSize === 'medium') gridSpan = Math.random() > 0.5 ? 'grid-column: span 2;' : 'grid-row: span 2;';
      else gridSpan = ''; // 1x1
      
      return `<div style="
        ${gridSpan}
        background: ${bgColor};
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      " onclick="editInvestment('${i.id}')" 
         onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 6px 16px rgba(0,0,0,0.15)';this.style.background='${isPositive ? 'rgba(76, 175, 120, 0.18)' : 'rgba(224, 92, 92, 0.18)'}';" 
         onmouseout="this.style.transform='';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)';this.style.background='${bgColor}';">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:16px;font-weight:600;color:var(--text);letter-spacing:0.5px;margin-bottom:8px;">${i.ticker}</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:22px;font-weight:600;color:${isPositive ? '#4caf78' : '#e05c5c'};">
          ${isPositive ? '+' : ''}${i.dailyChange.toFixed(2)}%
        </div>
      </div>`;
    }).join('');
  }

  updateProjection();
  calculateBond();
  renderBonds();
}

function calculateBond() {
  const principal = parseFloat(document.getElementById('bond-principal')?.value) || 100000;
  const rate = parseFloat(document.getElementById('bond-rate')?.value) / 100 || 0.045;
  const years = parseInt(document.getElementById('bond-years')?.value) || 5;
  const type = document.getElementById('bond-type')?.value || 'compound';
  const purchaseDateStr = document.getElementById('bond-purchase-date')?.value;

  let finalValue, currentValue, profit, currentProfit, formula, elapsed = 0, progress = 0;

  // Calculate final value at maturity
  if (type === 'simple') {
    finalValue = principal * (1 + rate * years);
    formula = `FV = ${principal.toLocaleString('cs-CZ')} Ã— (1 + ${(rate*100).toFixed(2)}% Ã— ${years})`;
  } else {
    finalValue = principal * Math.pow(1 + rate, years);
    formula = `FV = ${principal.toLocaleString('cs-CZ')} Ã— (1 + ${(rate*100).toFixed(2)}%)^${years}`;
  }

  profit = finalValue - principal;

  // If purchase date is set, calculate current value based on elapsed time
  if (purchaseDateStr) {
    const purchaseDate = new Date(purchaseDateStr);
    const today = new Date();
    const daysElapsed = Math.max(0, Math.floor((today - purchaseDate) / (1000 * 60 * 60 * 24)));
    elapsed = daysElapsed / 365; // years elapsed
    progress = Math.min((elapsed / years) * 100, 100);

    if (type === 'simple') {
      currentValue = principal * (1 + rate * elapsed);
    } else {
      currentValue = principal * Math.pow(1 + rate, elapsed);
    }
    currentProfit = currentValue - principal;
  } else {
    currentValue = principal;
    currentProfit = 0;
  }

  const yieldPct = (profit / principal) * 100;

  // Update display
  document.getElementById('bond-final').textContent = fmt(Math.round(finalValue));
  document.getElementById('bond-profit').textContent = '+' + fmt(Math.round(profit));
  document.getElementById('bond-yield').textContent = yieldPct.toFixed(1) + '%';
  document.getElementById('bond-formula').textContent = formula;

  // Show current value if purchase date is set
  const currentValueEl = document.getElementById('bond-current-value');
  if (purchaseDateStr && elapsed > 0) {
    currentValueEl.style.display = 'block';
    currentValueEl.innerHTML = `
      <div style="margin-bottom:14px;">
        <div style="font-size:13px;color:var(--text3);margin-bottom:6px;">AktuÃ¡lnÃ­ hodnota (po ${elapsed.toFixed(1)} letech)</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:22px;font-weight:600;color:var(--text);">${fmt(Math.round(currentValue))}</div>
        <div style="font-size:12px;color:var(--green);margin-top:2px;">+${fmt(Math.round(currentProfit))} dosaÅ¾enÃ½ zisk</div>
      </div>
      <div style="margin-bottom:8px;">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px;">PrÅ¯bÄ›h investice: ${progress.toFixed(0)}%</div>
        <div style="background:var(--bg);border-radius:4px;height:6px;overflow:hidden;">
          <div style="background:var(--gold2);height:100%;width:${progress}%;transition:width 0.3s;"></div>
        </div>
      </div>
    `;
  } else {
    currentValueEl.style.display = 'none';
  }
}

function editBond(id) {
  const b = db.bonds.find(bond => bond.id === id);
  if (!b) return;

  // Fill modal with bond data
  document.getElementById('bond-edit-id').value = id;
  document.getElementById('bond-modal-name').value = b.name;
  document.getElementById('bond-modal-category').value = b.category || 'bond';
  document.getElementById('bond-modal-principal').value = b.principal;
  document.getElementById('bond-modal-rate').value = b.rate;
  document.getElementById('bond-modal-years').value = b.years;
  document.getElementById('bond-modal-type').value = b.type;
  document.getElementById('bond-modal-purchase-date').value = b.purchaseDate;

  openModal('modal-bond');
}

function saveBondFromModal() {
  const editId = document.getElementById('bond-edit-id').value;
  const name = document.getElementById('bond-modal-name').value.trim();
  const category = document.getElementById('bond-modal-category').value;
  const principal = parseFloat(document.getElementById('bond-modal-principal').value);
  const rate = parseFloat(document.getElementById('bond-modal-rate').value);
  const years = parseInt(document.getElementById('bond-modal-years').value);
  const type = document.getElementById('bond-modal-type').value;
  const purchaseDateStr = document.getElementById('bond-modal-purchase-date').value;

  if (!name) { toast('Zadejte nÃ¡zev investice', 'error'); return; }
  if (!principal || principal <= 0) { toast('Zadejte platnou ÄÃ¡stku', 'error'); return; }
  if (!rate || rate <= 0) { toast('Zadejte platnou Ãºrokovou sazbu', 'error'); return; }
  if (!years || years <= 0) { toast('Zadejte dobu splatnosti', 'error'); return; }
  if (!purchaseDateStr) { toast('Zadejte datum nÃ¡kupu', 'error'); return; }

  const purchaseDate = new Date(purchaseDateStr);
  const maturityDate = new Date(purchaseDate);
  maturityDate.setFullYear(maturityDate.getFullYear() + years);

  const data = {
    name,
    category,
    principal,
    rate,
    years,
    type,
    purchaseDate: purchaseDate.toISOString().split('T')[0],
    maturityDate: maturityDate.toISOString().split('T')[0]
  };

  if (editId) {
    const idx = db.bonds.findIndex(b => b.id === editId);
    if (idx >= 0) {
      db.bonds[idx] = { ...db.bonds[idx], ...data };
    }
    toast('Investice upravena âœ“', 'success');
  }

  saveData(db);
  closeModal('modal-bond');
  renderBonds();
}

function saveBond() {
  const name = document.getElementById('bond-name').value.trim();
  const category = document.getElementById('bond-category').value;
  const principal = parseFloat(document.getElementById('bond-principal').value);
  const rate = parseFloat(document.getElementById('bond-rate').value);
  const years = parseInt(document.getElementById('bond-years').value);
  const type = document.getElementById('bond-type').value;
  const purchaseDateStr = document.getElementById('bond-purchase-date').value;
  const editId = document.getElementById('bond-name').dataset.editId;

  if (!name) { toast('Zadejte nÃ¡zev investice', 'error'); return; }
  if (!principal || principal <= 0) { toast('Zadejte platnou ÄÃ¡stku', 'error'); return; }
  if (!rate || rate <= 0) { toast('Zadejte platnou Ãºrokovou sazbu', 'error'); return; }
  if (!years || years <= 0) { toast('Zadejte dobu splatnosti', 'error'); return; }
  if (!purchaseDateStr) { toast('Zadejte datum nÃ¡kupu', 'error'); return; }

  const purchaseDate = new Date(purchaseDateStr);
  const maturityDate = new Date(purchaseDate);
  maturityDate.setFullYear(maturityDate.getFullYear() + years);

  const data = {
    name,
    category,
    principal,
    rate,
    years,
    type,
    purchaseDate: purchaseDate.toISOString().split('T')[0],
    maturityDate: maturityDate.toISOString().split('T')[0]
  };

  if (editId) {
    // Edit mode
    const idx = db.bonds.findIndex(b => b.id === editId);
    if (idx >= 0) {
      db.bonds[idx] = { ...db.bonds[idx], ...data };
    }
    toast('Investice upravena âœ“', 'success');
    delete document.getElementById('bond-name').dataset.editId;
  } else {
    // Add mode
    db.bonds.push({ id: uid(), ...data });
    toast('Investice uloÅ¾ena âœ“', 'success');
  }

  saveData(db);
  
  // Reset form
  document.getElementById('bond-name').value = '';
  document.getElementById('bond-category').value = 'bond';
  document.getElementById('bond-principal').value = '100000';
  document.getElementById('bond-rate').value = '4.5';
  document.getElementById('bond-years').value = '5';
  document.getElementById('bond-type').value = 'compound';
  document.getElementById('bond-purchase-date').value = '';
  
  // Reset button
  const saveBtn = document.getElementById('bond-save-btn');
  saveBtn.textContent = 'ğŸ’¾ UloÅ¾it investici';
  saveBtn.style.background = '';
  
  calculateBond();
  renderBonds();
}

function deleteBond(id) {
  db.bonds = db.bonds.filter(b => b.id !== id);
  saveData(db);
  renderBonds();
  toast('Investice smazÃ¡na');
}

function renderBonds() {
  if (!db.bonds) db.bonds = [];
  const list = document.getElementById('bonds-list');
  
  if (!db.bonds.length) {
    list.innerHTML = `<div class="empty-state" style="padding:28px 16px;"><div class="empty-state-text" style="font-size:13px;">ğŸ’° ZatÃ­m Å¾Ã¡dnÃ© uloÅ¾enÃ© investice</div></div>`;
    return;
  }

  const BOND_TYPES = {
    bond:     { icon: 'ğŸ“œ', label: 'Dluhopis', color: '#5b9bd5' },
    deposit:  { icon: 'ğŸ¦', label: 'TermÃ­novanÃ½ vklad', color: '#4caf78' },
    platform: { icon: 'ğŸ¢', label: 'InvestiÄnÃ­ platforma', color: '#c9a84c' },
  };

  list.innerHTML = db.bonds.map(b => {
    const principal = b.principal;
    const rate = b.rate / 100;
    const years = b.years;
    let finalValue, currentValue, currentProfit;
    
    if (b.type === 'simple') {
      finalValue = principal * (1 + rate * years);
    } else {
      finalValue = principal * Math.pow(1 + rate, years);
    }
    
    const profit = finalValue - principal;
    const yieldPct = (profit / principal) * 100;
    
    // Calculate current value and elapsed time
    const purchaseDate = new Date(b.purchaseDate);
    const today = new Date();
    const maturity = new Date(b.maturityDate);
    const totalDays = Math.floor((maturity - purchaseDate) / (1000 * 60 * 60 * 24));
    const elapsedDays = Math.max(0, Math.floor((today - purchaseDate) / (1000 * 60 * 60 * 24)));
    const elapsed = elapsedDays / 365; // years elapsed
    const progress = Math.min((elapsedDays / totalDays) * 100, 100);
    
    if (b.type === 'simple') {
      currentValue = principal * (1 + rate * elapsed);
    } else {
      currentValue = principal * Math.pow(1 + rate, elapsed);
    }
    currentProfit = currentValue - principal;
    
    // Calculate time remaining
    const daysRemaining = Math.max(0, Math.floor((maturity - today) / (1000 * 60 * 60 * 24)));
    const isMatured = daysRemaining === 0;
    
    let timeRemainingText;
    if (isMatured) {
      timeRemainingText = 'âœ“ SplatnÃ½';
    } else if (daysRemaining < 365) {
      const monthsRemaining = Math.round(daysRemaining / 30);
      timeRemainingText = monthsRemaining === 1 ? '1 mÄ›sÃ­c' : monthsRemaining + ' mÄ›sÃ­cÅ¯';
    } else {
      const yearsRemaining = (daysRemaining / 365).toFixed(1);
      timeRemainingText = yearsRemaining + ' let';
    }
    
    const bondType = BOND_TYPES[b.category] || BOND_TYPES.bond;
    
    return `<div class="budget-item" style="margin-bottom:12px;border-left:3px solid ${bondType.color};cursor:pointer;" onclick="editBond('${b.id}')" title="KliknÄ›te pro Ãºpravu">
      <div class="budget-header">
        <div class="budget-name">
          <span>${bondType.icon}</span>
          <span>${b.name}</span>
          <span style="font-size:11px;color:var(--text3);font-weight:400;">${bondType.label} Â· ${b.rate}% ${b.type === 'simple' ? 'prostÃ©' : 'sloÅ¾enÃ©'} Â· ${b.years} let</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="text-align:right;">
            <div style="font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:500;color:var(--text);">${fmt(Math.round(currentValue))} <span style="font-size:11px;color:var(--text3);">nynÃ­</span></div>
            <div style="font-size:11px;color:var(--green);">+${fmt(Math.round(currentProfit))} dosaÅ¾eno Â· ${fmt(Math.round(finalValue))} celkem</div>
          </div>
          <span style="font-size:12px;color:var(--text3);opacity:0.6;">âœ</span>
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteBond('${b.id}')" style="opacity:0.5;">ğŸ—‘</button>
        </div>
      </div>
      <div style="margin-top:10px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:4px;">
          <span>Pokrok investice: ${progress.toFixed(0)}%</span>
          <span>${elapsed.toFixed(1)} let uplynulo z ${years} let</span>
        </div>
        <div style="background:var(--bg);border-radius:4px;height:6px;overflow:hidden;">
          <div style="background:${bondType.color};height:100%;width:${progress}%;transition:width 0.3s;"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;font-size:12px;">
        <div>
          <div style="color:var(--text3);">InvestovÃ¡no</div>
          <div style="color:var(--text2);font-weight:500;">${fmt(principal)}</div>
        </div>
        <div>
          <div style="color:var(--text3);">Splatnost</div>
          <div style="color:var(--text2);font-weight:500;">${new Date(b.maturityDate).toLocaleDateString('cs-CZ', {day:'numeric', month:'short', year:'numeric'})}</div>
        </div>
        <div>
          <div style="color:var(--text3);">Do splatnosti</div>
          <div style="color:${isMatured ? 'var(--green)' : 'var(--text2)'};font-weight:500;">${timeRemainingText}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function setScenario(s) {
  activeScenario = s;
  document.querySelectorAll('#scenario-toggle .toggle-btn').forEach((btn, i) => {
    btn.classList.toggle('active', ['all','conservative','balanced','growth'][i] === s);
  });
  updateProjection();
}

function updateProjection() {
  const monthly = parseFloat(document.getElementById('sl-monthly').value) || 0;
  const horizon = parseInt(document.getElementById('sl-horizon').value) || 20;
  const rCons = parseFloat(document.getElementById('sl-cons').value) / 100;
  const rBal = parseFloat(document.getElementById('sl-bal').value) / 100;
  const rGrowth = parseFloat(document.getElementById('sl-growth').value) / 100;

  document.getElementById('lbl-monthly').textContent = fmt(monthly);
  document.getElementById('lbl-horizon').textContent = horizon + ' let';
  document.getElementById('lbl-cons').textContent = (rCons*100).toFixed(1) + '%';
  document.getElementById('lbl-bal').textContent = (rBal*100).toFixed(1) + '%';
  document.getElementById('lbl-growth').textContent = (rGrowth*100).toFixed(1) + '%';

  const startVal = db.investments.reduce((s,i) => s + i.quantity*i.currentPrice, 0);

  function project(rate, years) {
    let val = startVal;
    const monthRate = rate / 12;
    for (let m = 0; m < years * 12; m++) {
      val = val * (1 + monthRate) + monthly;
    }
    return val;
  }

  function projectByYear(rate, years) {
    const data = [startVal];
    let val = startVal;
    const monthRate = rate / 12;
    for (let y = 1; y <= years; y++) {
      for (let m = 0; m < 12; m++) {
        val = val * (1 + monthRate) + monthly;
      }
      data.push(val);
    }
    return data;
  }

  // Invested line
  const investedLine = [];
  for (let y = 0; y <= horizon; y++) investedLine.push(startVal + monthly * 12 * y);

  const labels = Array.from({length: horizon+1}, (_,i) => i === 0 ? 'Dnes' : `${i} r.`);

  const datasets = [];

  if (activeScenario === 'all' || activeScenario === 'conservative') {
    datasets.push({
      label: `KonzervativnÃ­ (${(rCons*100).toFixed(1)}%)`,
      data: projectByYear(rCons, horizon),
      borderColor: '#5b9bd5', backgroundColor: 'rgba(91,155,213,0.08)',
      borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4
    });
  }
  if (activeScenario === 'all' || activeScenario === 'balanced') {
    datasets.push({
      label: `VyvÃ¡Å¾enÃ½ (${(rBal*100).toFixed(1)}%)`,
      data: projectByYear(rBal, horizon),
      borderColor: '#c9a84c', backgroundColor: 'rgba(201,168,76,0.08)',
      borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4
    });
  }
  if (activeScenario === 'all' || activeScenario === 'growth') {
    datasets.push({
      label: `RÅ¯stovÃ½ (${(rGrowth*100).toFixed(1)}%)`,
      data: projectByYear(rGrowth, horizon),
      borderColor: '#4caf78', backgroundColor: 'rgba(76,175,120,0.08)',
      borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4
    });
  }
  datasets.push({
    label: 'VloÅ¾eno celkem',
    data: investedLine,
    borderColor: 'rgba(255,255,255,0.15)', backgroundColor: 'transparent',
    borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: false, tension: 0
  });

  if (projectionChart) projectionChart.destroy();
  const pCtx = document.getElementById('chart-projection').getContext('2d');
  projectionChart = new Chart(pCtx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color:'#a09890', font:{family:'IBM Plex Sans', size:12}, boxWidth:12 } },
        tooltip: {
          backgroundColor:'rgba(30,29,27,0.95)',
          borderColor:'rgba(255,255,255,0.08)',
          borderWidth:1,
          titleColor:'#f0ece4',
          bodyColor:'#a09890',
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${fmtShort(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: { ticks:{ color:'#6b6560', maxTicksLimit:8 }, grid:{ color:'rgba(255,255,255,0.04)' } },
        y: { ticks:{ color:'#6b6560', callback: v => fmtShort(v) }, grid:{ color:'rgba(255,255,255,0.04)' } }
      }
    }
  });

  // Projection stats
  const pivot = activeScenario === 'conservative' ? rCons : activeScenario === 'growth' ? rGrowth : rBal;
  document.getElementById('proj-10').textContent = horizon >= 10 ? fmtShort(project(pivot, 10)) : 'â€”';
  document.getElementById('proj-20').textContent = horizon >= 20 ? fmtShort(project(pivot, 20)) : 'â€”';
  document.getElementById('proj-30').textContent = horizon >= 30 ? fmtShort(project(pivot, 30)) : 'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CASHFLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CF_CATS = {
  income:   [
    { id:'salary',    name:'VÃ½plata / mzda',       emoji:'ğŸ’¼' },
    { id:'freelance', name:'Freelance / OSVÄŒ',      emoji:'ğŸ’»' },
    { id:'rent-in',   name:'NÃ¡jem z nemovitosti',   emoji:'ğŸ ' },
    { id:'dividend',  name:'Dividendy / investice', emoji:'ğŸ“ˆ' },
    { id:'pension',   name:'DÅ¯chod / penze',        emoji:'ğŸ¦' },
    { id:'other-in',  name:'OstatnÃ­ pÅ™Ã­jmy',         emoji:'ğŸ’°' },
  ],
  fixed:    [
    { id:'rent-out',  name:'NÃ¡jem / hypotÃ©ka',      emoji:'ğŸ ' },
    { id:'insurance', name:'PojiÅ¡tÄ›nÃ­',              emoji:'ğŸ›¡ï¸' },
    { id:'loan',      name:'SplÃ¡tka ÃºvÄ›ru',          emoji:'ğŸ¦' },
    { id:'utilities', name:'Energie / zÃ¡lohy',       emoji:'âš¡' },
    { id:'subscript', name:'PÅ™edplatnÃ© / sluÅ¾by',   emoji:'ğŸ“±' },
    { id:'transport', name:'Doprava / MHD',          emoji:'ğŸš—' },
    { id:'invest-fix',name:'Investice',              emoji:'ğŸ“ˆ' },
    { id:'other-fix', name:'OstatnÃ­ fixnÃ­',          emoji:'ğŸ“Œ' },
  ],
  variable: [
    { id:'food',      name:'JÃ­dlo & restaurace',    emoji:'ğŸ›’' },
    { id:'clothing',  name:'ObleÄenÃ­',               emoji:'ğŸ‘—' },
    { id:'health',    name:'ZdravÃ­ & lÃ©kÃ¡rna',       emoji:'ğŸ’Š' },
    { id:'sport',     name:'Sport & volnÃ½ Äas',      emoji:'ğŸƒ' },
    { id:'travel',    name:'CestovÃ¡nÃ­',              emoji:'âœˆï¸' },
    { id:'entertain', name:'ZÃ¡bava',                 emoji:'ğŸ¬' },
    { id:'other-var', name:'OstatnÃ­ variabilnÃ­',     emoji:'ğŸ“¦' },
  ],
  saving:   [
    { id:'emergency', name:'NouzovÃ½ fond',           emoji:'ğŸ›¡ï¸' },
    { id:'holiday',   name:'DovolenÃ¡',               emoji:'âœˆï¸' },
    { id:'invest-s',  name:'Investice',              emoji:'ğŸ“ˆ' },
    { id:'pension-s', name:'PenzijnÃ­ pÅ™ipojiÅ¡tÄ›nÃ­',  emoji:'ğŸ¦' },
    { id:'other-sav', name:'OstatnÃ­ spoÅ™enÃ­',        emoji:'ğŸ¯' },
  ],
};

const CF_TYPE_META = {
  income:   { label:'NovÃ½ pravidelnÃ½ pÅ™Ã­jem', editLabel:'Upravit pÅ™Ã­jem',    icon:'ğŸ’°', color:'var(--green)'  },
  fixed:    { label:'NovÃ½ fixnÃ­ vÃ½daj',        editLabel:'Upravit fixnÃ­ vÃ½daj', icon:'ğŸ“Œ', color:'var(--red)'    },
  variable: { label:'NovÃ½ variabilnÃ­ vÃ½daj',   editLabel:'Upravit variabilnÃ­ vÃ½daj', icon:'ğŸ“Š', color:'var(--blue)'   },
  saving:   { label:'NovÃ© spoÅ™enÃ­ / cÃ­l',      editLabel:'Upravit spoÅ™enÃ­',   icon:'ğŸ¯', color:'var(--gold2)'  },
};

function freqToMonthly(amount, freq) {
  if (freq === 'weekly')    return amount * 52 / 12;
  if (freq === 'quarterly') return amount / 3;
  if (freq === 'yearly')    return amount / 12;
  return amount;
}

function freqLabel(freq) {
  return { monthly:'mÄ›sÃ­ÄnÄ›', quarterly:'ÄtvrtletnÄ›', yearly:'roÄnÄ›', weekly:'tÃ½dnÄ›' }[freq] || freq;
}

function getCfCat(type, id) {
  const list = CF_CATS[type] || CF_CATS.fixed;
  return list.find(c => c.id === id) || list[list.length - 1];
}

function openCashflowModal(type, editId = null) {
  const meta = CF_TYPE_META[type] || CF_TYPE_META.fixed;
  document.getElementById('cf-item-type').value = type;
  document.getElementById('cf-edit-id').value = editId || '';
  document.getElementById('cf-modal-title').textContent = editId ? meta.editLabel : meta.label;
  document.getElementById('cf-save-btn').textContent = editId ? 'UloÅ¾it zmÄ›ny' : 'PÅ™idat';

  // Show/hide special fields
  document.getElementById('cf-limit-group').style.display  = type === 'variable' ? 'block' : 'none';
  document.getElementById('cf-goal-group').style.display   = type === 'saving'   ? 'block' : 'none';

  // Fill categories
  document.getElementById('cf-category').innerHTML =
    (CF_CATS[type] || []).map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');

  // Fill goal link options for saving
  if (type === 'saving') {
    document.getElementById('cf-goal-link').innerHTML =
      '<option value="">â€” bez propojenÃ­ â€”</option>' +
      db.goals.map(g => `<option value="${g.id}">${g.emoji} ${g.name}</option>`).join('');
  }

  // Fill fields
  if (editId) {
    const item = db.cashflow.find(i => i.id === editId);
    if (item) {
      document.getElementById('cf-name').value      = item.name;
      document.getElementById('cf-amount').value    = item.amount;
      document.getElementById('cf-frequency').value = item.frequency;
      document.getElementById('cf-category').value  = item.category;
      document.getElementById('cf-day').value       = item.day || '';
      document.getElementById('cf-note').value      = item.note || '';
      document.getElementById('cf-limit').value     = item.limit || '';
      document.getElementById('cf-goal-link').value = item.goalId || '';
    }
  } else {
    ['cf-name','cf-amount','cf-day','cf-note','cf-limit'].forEach(id => {
      const el = document.getElementById(id); if(el) el.value = '';
    });
    document.getElementById('cf-frequency').value = 'monthly';
    document.getElementById('cf-amount-preview').style.display = 'none';
    const goalEl = document.getElementById('cf-goal-link');
    if (goalEl) goalEl.value = '';
  }

  openModal('modal-cashflow');
}

function updateCfPreview() {
  const amount = parseFloat(document.getElementById('cf-amount').value);
  const freq   = document.getElementById('cf-frequency').value;
  const preview = document.getElementById('cf-amount-preview');
  if (!amount || freq === 'monthly') { preview.style.display = 'none'; return; }
  const monthly = freqToMonthly(amount, freq);
  preview.style.display = 'block';
  preview.innerHTML = `â‡„ ${fmt(amount)} ${freqLabel(freq)} = <strong style="color:var(--gold2)">${fmt(Math.round(monthly))} / mÄ›sÃ­c</strong>`;
}

function saveCashflowItem() {
  const name   = document.getElementById('cf-name').value.trim();
  const amount = parseFloat(document.getElementById('cf-amount').value);
  const type   = document.getElementById('cf-item-type').value;
  const editId = document.getElementById('cf-edit-id').value;

  if (!name)               { toast('Zadejte nÃ¡zev', 'error'); return; }
  if (!amount || amount <= 0) { toast('Zadejte platnou ÄÃ¡stku', 'error'); return; }

  const data = {
    name, type, amount,
    frequency: document.getElementById('cf-frequency').value,
    category:  document.getElementById('cf-category').value,
    day:       parseInt(document.getElementById('cf-day').value) || null,
    note:      document.getElementById('cf-note').value.trim(),
    limit:     type === 'variable' ? (parseFloat(document.getElementById('cf-limit').value) || null) : null,
    goalId:    type === 'saving'   ? (document.getElementById('cf-goal-link').value || null) : null,
  };

  if (editId) {
    const idx = db.cashflow.findIndex(i => i.id === editId);
    if (idx >= 0) db.cashflow[idx] = { ...db.cashflow[idx], ...data };
    toast('PoloÅ¾ka upravena âœ“', 'success');
  } else {
    db.cashflow.push({ id: uid(), ...data });
    toast('PoloÅ¾ka pÅ™idÃ¡na âœ“', 'success');
  }

  saveData(db);
  closeModal('modal-cashflow');
  renderCashflow();
}

function deleteCashflowItem(id) {
  db.cashflow = db.cashflow.filter(i => i.id !== id);
  saveData(db);
  renderCashflow();
  toast('PoloÅ¾ka smazÃ¡na');
}

let cfWaterfallChart, cfDonutChart;

function renderCashflow() {
  if (!db.cashflow) db.cashflow = [];

  const byType = {
    income:   db.cashflow.filter(i => i.type === 'income'),
    fixed:    db.cashflow.filter(i => i.type === 'fixed'    || i.type === 'expense'),
    variable: db.cashflow.filter(i => i.type === 'variable'),
    saving:   db.cashflow.filter(i => i.type === 'saving'),
  };

  const totals = {};
  Object.entries(byType).forEach(([t, items]) => {
    totals[t] = items.reduce((s, i) => s + freqToMonthly(i.amount, i.frequency), 0);
  });

  const totalOut = totals.fixed + totals.variable + totals.saving;
  const free = totals.income - totalOut;
  const freePct = totals.income > 0 ? (free / totals.income * 100) : 0;

  // Summary cards
  document.getElementById('cf-total-income').textContent   = fmt(Math.round(totals.income));
  document.getElementById('cf-total-fixed').textContent    = fmt(Math.round(totals.fixed));
  document.getElementById('cf-total-variable').textContent = fmt(Math.round(totals.variable));
  document.getElementById('cf-total-saving').textContent   = fmt(Math.round(totals.saving));
  document.getElementById('cf-income-count').textContent   = byType.income.length   + ' poloÅ¾ek';
  document.getElementById('cf-fixed-count').textContent    = byType.fixed.length    + ' poloÅ¾ek';
  document.getElementById('cf-variable-count').textContent = byType.variable.length + ' poloÅ¾ek';
  document.getElementById('cf-saving-count').textContent   = byType.saving.length   + ' poloÅ¾ek';

  const freeEl = document.getElementById('cf-free');
  freeEl.textContent = fmt(Math.round(free));
  freeEl.style.color = free >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('cf-free-pct').textContent = freePct.toFixed(0) + ' % z pÅ™Ã­jmÅ¯';

  // Render lists
  const EMPTY = { income:'ğŸ’° PÅ™idejte pravidelnÃ½ pÅ™Ã­jem', fixed:'ğŸ“Œ PÅ™idejte fixnÃ­ vÃ½daj', variable:'ğŸ“Š PÅ™idejte variabilnÃ­ vÃ½daj s limitem', saving:'ğŸ¯ PÅ™idejte spoÅ™icÃ­ poloÅ¾ku' };
  ['income','fixed','variable','saving'].forEach(t => {
    const el = document.getElementById('cf-' + t + '-list');
    if (!byType[t].length) {
      el.innerHTML = `<div class="empty-state" style="padding:28px 16px;"><div class="empty-state-text" style="font-size:13px;">${EMPTY[t]}</div></div>`;
    } else {
      el.innerHTML = byType[t].map(i => cfItemHTML(i, totals.income)).join('');
    }
  });

  // â”€â”€ Waterfall chart â”€â”€
  if (cfWaterfallChart) cfWaterfallChart.destroy();
  const wCtx = document.getElementById('chart-cf-waterfall').getContext('2d');

  const wLabels = ['PÅ™Ã­jmy', 'FixnÃ­ vÃ½daje', 'VariabilnÃ­', 'SpoÅ™enÃ­', 'VolnÃ© CF'];
  const wAbsValues = [totals.income, totals.fixed, totals.variable, totals.saving, Math.abs(free)];
  const wColors = [
    'rgba(76,175,120,0.85)',
    'rgba(224,92,92,0.8)',
    'rgba(91,155,213,0.8)',
    'rgba(201,168,76,0.8)',
    free >= 0 ? 'rgba(76,175,120,0.7)' : 'rgba(224,92,92,0.7)',
  ];

  cfWaterfallChart = new Chart(wCtx, {
    type: 'bar',
    data: {
      labels: wLabels,
      datasets: [{
        data: wAbsValues,
        backgroundColor: wColors,
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(30,29,27,0.95)',
          borderColor: 'rgba(255,255,255,0.08)', borderWidth: 1,
          titleColor: '#f0ece4', bodyColor: '#a09890',
          callbacks: { label: ctx => ' ' + fmt(Math.round(wAbsValues[ctx.dataIndex])) }
        }
      },
      scales: {
        x: { ticks: { color:'#6b6560', font:{ size:11 } }, grid: { display:false } },
        y: { ticks: { color:'#6b6560', callback: v => Math.round(v/1000)+'k' }, grid: { color:'rgba(255,255,255,0.04)' } }
      }
    }
  });

  // â”€â”€ Donut chart â”€â”€
  if (cfDonutChart) cfDonutChart.destroy();
  const dCtx = document.getElementById('chart-cf-donut').getContext('2d');
  const donutData = {
    'FixnÃ­ vÃ½daje':    totals.fixed,
    'VariabilnÃ­ vÃ½daje': totals.variable,
    'SpoÅ™enÃ­':         totals.saving,
  };
  if (free > 0) donutData['VolnÃ© cashflow'] = free;

  const donutColors = ['#e05c5c','#5b9bd5','#c9a84c','#4caf78','#8b7fd5'];
  const donutVals = Object.values(donutData).filter(v => v > 0);
  const donutLabels = Object.entries(donutData).filter(([,v]) => v > 0).map(([k]) => k);

  if (donutVals.length) {
    cfDonutChart = new Chart(dCtx, {
      type: 'doughnut',
      data: {
        labels: donutLabels,
        datasets: [{ data: donutVals.map(Math.round), backgroundColor: donutColors, borderWidth: 0, hoverOffset: 6 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, cutout: '60%',
        plugins: {
          legend: { position:'right', labels:{ color:'#a09890', font:{ family:'IBM Plex Sans', size:11 }, padding:10 } },
          tooltip: {
            backgroundColor:'rgba(30,29,27,0.95)', borderColor:'rgba(255,255,255,0.08)', borderWidth:1,
            titleColor:'#f0ece4', bodyColor:'#a09890',
            callbacks: { label: ctx => ` ${fmt(ctx.parsed)} (${totals.income > 0 ? (ctx.parsed/totals.income*100).toFixed(0) : 0}%)` }
          }
        }
      }
    });
  }
}

function cfItemHTML(item, totalIncome) {
  const monthly = freqToMonthly(item.amount, item.frequency);
  const type = item.type === 'expense' ? 'fixed' : item.type; // migrate old 'expense' type
  const cat  = getCfCat(type, item.category);
  const meta = CF_TYPE_META[type] || CF_TYPE_META.fixed;
  const pct  = totalIncome > 0 ? (monthly / totalIncome * 100) : 0;
  const isIncome = type === 'income';
  const amountColor = isIncome ? 'var(--green)' : type === 'saving' ? 'var(--gold2)' : type === 'variable' ? 'var(--blue)' : 'var(--red)';
  const barColor    = isIncome ? 'green' : type === 'saving' ? 'gold' : type === 'variable' ? 'blue' : (pct > 25 ? 'red' : 'blue');
  const freqNote = item.frequency !== 'monthly' ? ` Â· ${fmt(Math.round(item.amount))} ${freqLabel(item.frequency)}` : '';
  const dayNote  = item.day ? ` Â· ${item.day}. v mÄ›sÃ­ci` : '';

  // limit indicator for variable
  let limitNote = '';
  if (type === 'variable' && item.limit) {
    const limitPct = Math.min((monthly / item.limit) * 100, 100);
    const over = monthly > item.limit;
    limitNote = `<div style="margin-top:6px;">
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:4px;">
        <span>Limit: ${fmt(item.limit)}/mÄ›s</span>
        <span style="color:${over?'var(--red)':'var(--text3)'};">${over?'PÅ™eÄerpÃ¡no o '+fmt(Math.round(monthly-item.limit)):'ZbÃ½vÃ¡ '+fmt(Math.round(item.limit-monthly))}</span>
      </div>
      <div class="progress-bar-bg"><div class="progress-bar-fill ${over?'red':'green'}" style="width:${limitPct.toFixed(0)}%;"></div></div>
    </div>`;
  }

  // linked goal for saving
  let goalNote = '';
  if (type === 'saving' && item.goalId) {
    const g = db.goals.find(g => g.id === item.goalId);
    if (g) goalNote = `<div style="font-size:11px;color:var(--gold2);margin-top:4px;">â†’ CÃ­l: ${g.emoji} ${g.name}</div>`;
  }

  return `<div class="budget-item" style="cursor:pointer;" onclick="openCashflowModal('${type}','${item.id}')">
    <div class="budget-header">
      <div class="budget-name">
        <span>${cat.emoji}</span>
        <span>${item.name}</span>
        <span style="font-size:11px;color:var(--text3);font-weight:400;">${cat.name}</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="text-align:right;">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:500;color:${amountColor};">${isIncome?'+':'âˆ’'}${fmt(Math.round(monthly))}<span style="font-size:11px;color:var(--text3);">/mÄ›s</span></div>
          <div style="font-size:11px;color:var(--text3);">${freqNote}${dayNote}</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteCashflowItem('${item.id}')" style="opacity:0.5;">ğŸ—‘</button>
      </div>
    </div>
    ${type !== 'variable' ? `<div class="progress-bar-wrap"><div class="progress-bar-bg"><div class="progress-bar-fill ${barColor}" style="width:${Math.min(pct,100).toFixed(1)}%;"></div></div></div><div style="font-size:11px;color:var(--text3);margin-top:4px;">${pct.toFixed(0)} % z pÅ™Ã­jmÅ¯${item.note ? ' Â· '+item.note : ''}</div>` : `<div style="font-size:11px;color:var(--text3);margin-top:4px;">${pct.toFixed(0)} % z pÅ™Ã­jmÅ¯${item.note ? ' Â· '+item.note : ''}</div>`}
    ${limitNote}
    ${goalNote}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => el.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRICE FETCHING VIA CLAUDE AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const APIKEY_STORAGE = 'penezenka_apikey';

function getApiKey() {
  return localStorage.getItem(APIKEY_STORAGE) || '';
}

function saveApiKey() {
  const key = document.getElementById('apikey-input').value.trim();
  if (!key.startsWith('sk-ant-')) {
    toast('NeplatnÃ½ formÃ¡t klÃ­Äe (musÃ­ zaÄÃ­nat sk-ant-)', 'error');
    return;
  }
  localStorage.setItem(APIKEY_STORAGE, key);
  closeModal('modal-apikey');
  toast('API klÃ­Ä uloÅ¾en âœ“', 'success');
  fetchPricesIfPossible();
}

function setPriceStatus(state, msg) {
  const el = document.getElementById('price-status');
  if (!el) return;
  const icons = { loading: 'âŸ³', ok: 'â—', error: 'â—', none: '' };
  const colors = { loading: 'var(--text3)', ok: 'var(--green)', error: 'var(--red)', none: 'var(--text3)' };
  el.innerHTML = `<span style="color:${colors[state]};font-size:16px;${state==='loading'?'animation:spin 1s linear infinite;display:inline-block;':''}">${icons[state]}</span> <span>${msg}</span>`;
}

// Add spin animation
const spinStyle = document.createElement('style');
spinStyle.textContent = '@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }';
document.head.appendChild(spinStyle);

async function fetchPricesIfPossible() {
  const apiKey = getApiKey();
  if (!db.investments.length) return;

  if (!apiKey) {
    setPriceStatus('none', 'Ceny se nenaÄÃ­tajÃ­ â€“ <a href="#" onclick="openModal(\'modal-apikey\');return false;" style="color:var(--gold2);text-decoration:none;">nastavte API klÃ­Ä</a>');
    return;
  }

  setPriceStatus('loading', 'NaÄÃ­tÃ¡m aktuÃ¡lnÃ­ cenyâ€¦');

  // Build list of assets to price
  const assets = db.investments.map(i => ({
    id: i.id,
    name: i.name,
    ticker: i.ticker,
    type: i.type
  }));

  const prompt = `Jsi finanÄnÃ­ asistent. UÅ¾ivatel mÃ¡ tato investiÄnÃ­ aktiva a potÅ™ebuje jejich aktuÃ¡lnÃ­ trÅ¾nÃ­ ceny v CZK (ÄeskÃ½ch korunÃ¡ch).

Aktiva:
${assets.map(a => `- ID: ${a.id}, NÃ¡zev: ${a.name}, Ticker: ${a.ticker}, Typ: ${a.type}`).join('\n')}

Instrukce:
1. Vyhledej aktuÃ¡lnÃ­ ceny tÄ›chto aktiv.
2. Pro ETF a akcie hledej cenu na burze (v USD nebo EUR) a pÅ™epoÄÃ­tej na CZK (aktuÃ¡lnÃ­ kurz).
3. Pro krypto hledej cenu v CZK nebo USD a pÅ™epoÄÃ­tej.
4. Pro penzijnÃ­ spoÅ™enÃ­ nebo nemovitosti vraÅ¥ null (nelze automaticky naÄÃ­st).
5. OdpovÄ›z POUZE jako JSON objekt bez jakÃ©hokoliv dalÅ¡Ã­ho textu nebo markdown:
{"prices": [{"id": "...", "currentPrice": 1234.56, "currency": "CZK", "source": "krÃ¡tkÃ½ popis zdroje/burzy"}]}
6. Pokud cenu nelze zjistit, pouÅ¾ij null pro currentPrice.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 1000,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      if (err.error?.type === 'authentication_error') {
        setPriceStatus('error', 'NeplatnÃ½ API klÃ­Ä');
        toast('NeplatnÃ½ API klÃ­Ä', 'error');
      } else {
        setPriceStatus('error', 'Chyba API: ' + (err.error?.message || response.status));
      }
      return;
    }

    const data = await response.json();

    // Extract text from response (may include tool use blocks)
    const textBlocks = data.content.filter(b => b.type === 'text').map(b => b.text).join('');

    // Parse JSON from response
    let parsed;
    try {
      const clean = textBlocks.replace(/```json|```/g, '').trim();
      // Find JSON object in text
      const match = clean.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('No JSON found');
      parsed = JSON.parse(match[0]);
    } catch {
      setPriceStatus('error', 'NepodaÅ™ilo se pÅ™eÄÃ­st odpovÄ›Ä');
      toast('Chyba pÅ™i zpracovÃ¡nÃ­ cen', 'error');
      return;
    }

    if (!parsed.prices || !Array.isArray(parsed.prices)) {
      setPriceStatus('error', 'NeoÄekÃ¡vanÃ½ formÃ¡t odpovÄ›di');
      return;
    }

    let updated = 0;
    parsed.prices.forEach(p => {
      if (p.currentPrice && p.currentPrice > 0) {
        const inv = db.investments.find(i => i.id === p.id);
        if (inv) {
          inv.currentPrice = p.currentPrice;
          inv.priceSource = p.source || '';
          updated++;
        }
      }
    });

    if (updated > 0) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
      saveData(db);
      renderInvestments();
      renderDashboard();
      setPriceStatus('ok', `Ceny aktualizovÃ¡ny v ${timeStr} (${updated}/${assets.length} aktiv)`);
      toast(`AktualizovÃ¡no ${updated} cen âœ“`, 'success');
    } else {
      setPriceStatus('error', 'Å½Ã¡dnÃ© ceny se nepodaÅ™ilo naÄÃ­st');
      toast('NepodaÅ™ilo se naÄÃ­st Å¾Ã¡dnÃ© ceny', 'error');
    }

  } catch (err) {
    setPriceStatus('error', 'Chyba pÅ™ipojenÃ­');
    toast('Chyba pÅ™ipojenÃ­ k API', 'error');
    console.error(err);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Wire up live conversion preview
['inv-buy-price','inv-buy-currency','inv-current-price','inv-current-currency','rate-usd','rate-eur'].forEach(id => {
  document.getElementById(id)?.addEventListener('input', updateConversionPreview);
});

function init() {
  // Seed demo data if empty
  if (!db.accounts.length && !db.transactions.length) {
    db.accounts = [
      { id:'a1', name:'BÄ›Å¾nÃ½ ÃºÄet', type:'bank', initialBalance:45000 },
      { id:'a2', name:'SpoÅ™icÃ­ ÃºÄet', type:'savings', initialBalance:120000 },
      { id:'a3', name:'Hotovost', type:'cash', initialBalance:3500 },
    ];
    const today = new Date();
    const fmt_d = (d) => d.toISOString().split('T')[0];
    const d0 = (n) => { const d = new Date(today); d.setDate(d.getDate()-n); return fmt_d(d); };

    db.transactions = [
      { id:'t1', type:'income', amount:52000, name:'VÃ½plata', date:d0(1), category:'income', account:'a1', note:'' },
      { id:'t2', type:'expense', amount:16500, name:'NÃ¡jem', date:d0(2), category:'housing', account:'a1', note:'' },
      { id:'t3', type:'expense', amount:2340, name:'Tesco â€“ nÃ¡kup', date:d0(3), category:'food', account:'a1', note:'' },
      { id:'t4', type:'expense', amount:890, name:'BenzÃ­n', date:d0(4), category:'transport', account:'a3', note:'' },
      { id:'t5', type:'expense', amount:599, name:'Spotify + Netflix', date:d0(5), category:'entertainment', account:'a1', note:'' },
      { id:'t6', type:'expense', amount:1200, name:'Restaurace', date:d0(6), category:'food', account:'a3', note:'' },
      { id:'t7', type:'expense', amount:3200, name:'ObleÄenÃ­', date:d0(7), category:'clothing', account:'a1', note:'' },
      { id:'t8', type:'income', amount:8000, name:'Freelance projekt', date:d0(10), category:'income', account:'a1', note:'' },
    ];
    db.budgets = [
      { id:'b1', category:'food', limit:8000 },
      { id:'b2', category:'entertainment', limit:2000 },
      { id:'b3', category:'transport', limit:3000 },
      { id:'b4', category:'clothing', limit:2000 },
    ];
    db.goals = [
      { id:'g1', name:'DovolenÃ¡ v ItÃ¡lii', emoji:'ğŸ‡®ğŸ‡¹', target:60000, current:18000, deadline: fmt_d(new Date(today.getFullYear(), today.getMonth()+6, 1)) },
      { id:'g2', name:'NovÃ½ MacBook', emoji:'ğŸ’»', target:45000, current:31000, deadline: fmt_d(new Date(today.getFullYear(), today.getMonth()+2, 1)) },
      { id:'g3', name:'NouzovÃ½ fond', emoji:'ğŸ›¡ï¸', target:150000, current:120000, deadline: '' },
    ];
    db.investments = [
      { id:'i1', name:'iShares Core S&P 500', ticker:'SXR8', type:'etf', quantity:12, buyPrice:8200, currentPrice:9450 },
      { id:'i2', name:'Bitcoin', ticker:'BTC', type:'crypto', quantity:0.15, buyPrice:980000, currentPrice:1250000 },
      { id:'i3', name:'PenzijnÃ­ spoÅ™enÃ­', ticker:'PENZ', type:'pension', quantity:1, buyPrice:85000, currentPrice:92000 },
      { id:'i4', name:'ÄŒSOB BalancovanÃ½ fond', ticker:'CSOB', type:'etf', quantity:50, buyPrice:1200, currentPrice:1340 },
    ];
    db.cashflow = [
      { id:'cf1', type:'income',   name:'VÃ½plata',           category:'salary',    amount:52000, frequency:'monthly',  day:15, note:'' },
      { id:'cf2', type:'income',   name:'Freelance pÅ™Ã­jmy',  category:'freelance', amount:8000,  frequency:'monthly',  day:null, note:'prÅ¯mÄ›r' },
      { id:'cf3', type:'fixed',    name:'NÃ¡jem bytu',         category:'rent-out',  amount:16500, frequency:'monthly',  day:1,  note:'' },
      { id:'cf4', type:'fixed',    name:'ZÃ¡lohy energie',     category:'utilities', amount:2400,  frequency:'monthly',  day:5,  note:'elektÅ™ina + plyn' },
      { id:'cf5', type:'fixed',    name:'PojiÅ¡tÄ›nÃ­ auta',     category:'insurance', amount:14400, frequency:'yearly',   day:null, note:'' },
      { id:'cf6', type:'fixed',    name:'MobilnÃ­ tarif',      category:'subscript', amount:499,   frequency:'monthly',  day:20, note:'' },
      { id:'cf7', type:'fixed',    name:'MHD roÄnÃ­ kupÃ³n',    category:'transport', amount:3650,  frequency:'yearly',   day:null, note:'' },
      { id:'cf8', type:'variable', name:'JÃ­dlo & restaurace', category:'food',      amount:6000,  frequency:'monthly',  day:null, note:'', limit:8000 },
      { id:'cf9', type:'variable', name:'ZÃ¡bava & volnÃ½ Äas', category:'entertain', amount:1200,  frequency:'monthly',  day:null, note:'', limit:2000 },
      { id:'cf10',type:'variable', name:'ObleÄenÃ­',           category:'clothing',  amount:800,   frequency:'monthly',  day:null, note:'prÅ¯mÄ›r', limit:1500 },
      { id:'cf11',type:'saving',   name:'NouzovÃ½ fond',       category:'emergency', amount:3000,  frequency:'monthly',  day:null, note:'', goalId:'g3' },
      { id:'cf12',type:'saving',   name:'DovolenÃ¡ ItÃ¡lie',    category:'holiday',   amount:5000,  frequency:'monthly',  day:null, note:'', goalId:'g1' },
      { id:'cf13',type:'saving',   name:'Investice ETF',      category:'invest-s',  amount:4000,  frequency:'monthly',  day:null, note:'' },
    ];
    saveData(db);
  }

  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SWIPE GESTURES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initSwipe(element, onEdit, onDelete) {
  let startX = 0;
  let currentX = 0;
  let isDragging = false;
  let hasMoved = false;
  
  const content = element.querySelector('.swipe-content') || element;
  const threshold = 80; // pixels to trigger action
  
  function handleStart(e) {
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = startX;
    isDragging = true;
    hasMoved = false;
    content.style.transition = 'none';
  }
  
  function handleMove(e) {
    if (!isDragging) return;
    
    currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const diff = currentX - startX;
    hasMoved = Math.abs(diff) > 5;
    
    // Limit swipe distance
    const maxSwipe = 140;
    const limitedDiff = Math.max(-maxSwipe, Math.min(maxSwipe, diff));
    
    content.style.transform = `translateX(${limitedDiff}px)`;
    
    if (e.cancelable) {
      e.preventDefault();
    }
  }
  
  function handleEnd() {
    if (!isDragging) return;
    isDragging = false;
    
    const diff = currentX - startX;
    content.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    
    // Swipe right (edit)
    if (diff > threshold && onEdit) {
      content.style.transform = 'translateX(140px)';
      setTimeout(() => {
        onEdit();
        resetSwipe();
      }, 150);
    }
    // Swipe left (delete)
    else if (diff < -threshold && onDelete) {
      content.style.transform = 'translateX(-140px)';
      setTimeout(() => {
        if (confirm('Opravdu smazat tuto poloÅ¾ku?')) {
          onDelete();
        }
        resetSwipe();
      }, 150);
    }
    // Reset if not enough swipe
    else {
      resetSwipe();
    }
  }
  
  function resetSwipe() {
    content.style.transform = 'translateX(0)';
  }
  
  // Touch events
  element.addEventListener('touchstart', handleStart, { passive: true });
  element.addEventListener('touchmove', handleMove, { passive: false });
  element.addEventListener('touchend', handleEnd);
  
  // Mouse events (for desktop testing)
  element.addEventListener('mousedown', handleStart);
  element.addEventListener('mousemove', handleMove);
  element.addEventListener('mouseup', handleEnd);
  element.addEventListener('mouseleave', () => {
    if (isDragging) handleEnd();
  });
  
  // Click prevention if swiped
  element.addEventListener('click', (e) => {
    if (hasMoved) {
      e.stopPropagation();
      e.preventDefault();
    }
  }, true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  // Update button text and icon
  const icon = document.getElementById('theme-icon');
  const text = document.getElementById('theme-text');
  
  if (newTheme === 'light') {
    icon.textContent = 'ğŸŒ™';
    text.textContent = 'TmavÃ½ reÅ¾im';
  } else {
    icon.textContent = 'â˜€ï¸';
    text.textContent = 'SvÄ›tlÃ½ reÅ¾im';
  }
}

// Load saved theme on startup
function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  const html = document.documentElement;
  html.setAttribute('data-theme', savedTheme);
  
  const icon = document.getElementById('theme-icon');
  const text = document.getElementById('theme-text');
  
  if (savedTheme === 'light') {
    icon.textContent = 'ğŸŒ™';
    text.textContent = 'TmavÃ½ reÅ¾im';
  } else {
    icon.textContent = 'â˜€ï¸';
    text.textContent = 'SvÄ›tlÃ½ reÅ¾im';
  }
}

loadTheme();
init();
</script>
</body>
</html>
